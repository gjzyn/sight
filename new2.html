<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SIGHT - SDO Mandaluyong Inventory</title>
    
    <!-- UI Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <!-- Login Icons -->
    <link href="https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css" rel="stylesheet">
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        /* ================= GLOBAL VARIABLES & RESET ================= */
        :root {
            --primary: #D4AF37;
            --primary-light: #F3E5AB;
            --dark: #2C3E50;
            --light: #ECF0F1;
            --border: #BDC3C7;
            --slate: #546E7A;
            --login-primary: #c6c3c3;
            --login-second: white;
            --login-black: black;
            --login-gold: #ddc435;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', system-ui, sans-serif;
        }

        body {
            background-color: #F4F6F8;
            color: var(--dark);
            overflow-x: hidden;
        }

        /* ================= UTILITY CLASSES ================= */
        .hidden {
            display: none !important;
        }

        .page {
            min-height: 100vh;
            padding-top: 130px; /* Accounts for Navbar + Spacing */
        }

        /* Admin Page padding fix */
        #officer-dashboard {
            padding-top: 130px !important;
        }

        /* ================= ANIMATIONS ================= */
        @keyframes slideContentUp {
            0% {
                opacity: 0;
                transform: translateY(15px);
            }
            100% {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Apply animation to content containers only */
        .page.active .login_box,
        .page.active .container,
        .page.active .slip-container,
        .page.active .inventory-list,
        .page.active .dashboard-grid,
        .page.active .admin-content-panel {
            animation: slideContentUp 0.5s ease-out forwards;
        }

        /* Special Sticky Animation */
        @keyframes stickySlideUp {
            0% {
                opacity: 0;
                transform: translateY(20px);
            }
            100% {
                opacity: 1;
                transform: none;
            }
        }

        .page.active .sidebar {
            animation: stickySlideUp 0.6s ease-out forwards;
        }

        /* ================= NAVBAR (SHARED & ADMIN) ================= */
        #navbar, .admin-header {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100px;
            background-image: url('header2.png');
            background-size: cover;
            background-position: center center;
            background-repeat: no-repeat;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 30px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            z-index: 1000;
        }

        .nav-left {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .logo-btn {
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .logoheh {
            width: 50px;
            height: 50px;
        }

        .sightlogo {
            width: 140px;
            height: auto;
        }

        /* Search Bar */
        .nav-center {
            flex: 1;
            display: flex;
            justify-content: center;
            padding: 0 20px;
        }

        .search-container {
            position: relative;
            width: 100%;
            max-width: 600px;
        }

        .search-wrapper {
            display: flex;
            width: 100%;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            border-radius: 5px;
        }

        #searchInput {
            width: 100%;
            padding: 12px 15px;
            border-radius: 5px 0 0 5px;
            border: 2px solid white;
            border-right: none;
            outline: none;
            font-size: 1rem;
            transition: 0.3s;
        }

        .search-btn {
            background: white;
            border: 2px solid white;
            border-left: none;
            border-radius: 0 5px 5px 0;
            padding: 0 20px;
            cursor: pointer;
            color: var(--dark);
            font-size: 1.1rem;
            transition: 0.3s;
        }

        #searchInput:focus {
            border-color: var(--dark);
        }

        #searchInput:focus + .search-btn {
            border-color: var(--dark);
        }

        .search-btn:hover {
            background: #eee;
            color: var(--primary);
        }

        /* Nav Right Icons */
        .nav-right {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .nav-icon {
            color: var(--dark);
            font-size: 1.4rem;
            text-decoration: none;
            position: relative;
            transition: 0.2s;
        }

        .nav-icon:hover {
            transform: scale(1.1);
            color: white;
            text-shadow: 0 0 5px black;
        }

        #cart-count {
            background: red;
            color: white;
            border-radius: 50%;
            padding: 2px 6px;
            font-size: 10px;
            position: absolute;
            top: -5px;
            right: -8px;
            border: 2px solid white;
        }

        .nav-logout-btn {
            background-color: var(--dark);
            color: white;
            padding: 8px 20px;
            border-radius: 25px;
            font-size: 0.9rem;
            font-weight: bold;
            text-decoration: none;
            transition: 0.3s;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .nav-logout-btn:hover {
            background-color: #bfa030;
            transform: translateY(-2px);
        }

        /* ================= LOGIN PAGE ================= */
        #login-page {
            padding-top: 0;
            background-image: url("sight.png");
            background-position: center;
            background-size: cover;
            background-repeat: no-repeat;
            background-attachment: fixed;
            background-color: #333;
        }

        .wrapper {
            width: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background-color: rgba(0, 0, 0, 0.4);
        }

        .login_box {
            position: relative;
            width: 450px;
            backdrop-filter: blur(10px);
            border: 2px solid var(--login-primary);
            border-radius: 15px;
            padding: 5.5em 2.5em 1em 2.5em;
            color: var(--login-second);
            box-shadow: 0px 0px 10px 2px var(--login-gold);
            background: rgba(255, 255, 255, 0.1);
        }

        .login-header {
            position: absolute;
            top: 0;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: var(--login-gold);
            width: 140px;
            height: 70px;
            border-radius: 0 0 20px 20px;
        }

        .login-header span {
            font-size: 30px;
            color: var(--login-black);
            font-weight: bold;
        }

        .login-header::before {
            content: "";
            position: absolute;
            top: 0;
            left: -30px;
            width: 30px;
            border-top-right-radius: 50%;
            background: transparent;
            box-shadow: -15px 0 0 0 var(--login-primary);
        }

        .login-header::after {
            content: "";
            position: absolute;
            top: 0;
            right: -30px;
            width: 30px;
            border-top-left-radius: 50%;
            background: transparent;
            box-shadow: -15px 0 0 0 var(--login-primary);
        }

        .input_box {
            position: relative;
            margin: 20px 0;
        }

        .input-field {
            width: 100%;
            height: 55px;
            font-size: 16px;
            background: transparent;
            color: var(--login-second);
            padding-inline: 20px 50px;
            border: 2px solid var(--login-primary);
            border-radius: 30px;
            outline: none;
        }

        .input-field:focus, .input-field:not(:placeholder-shown) {
            border-color: var(--login-gold);
        }

        .label {
            position: absolute;
            top: 15px;
            left: 20px;
            transition: .2s;
            pointer-events: none;
            color: rgba(255, 255, 255, 0.85);
        }

        .input-field:focus ~ .label, .input-field:not(:placeholder-shown) ~ .label {
            top: -10px;
            left: 20px;
            font-size: 12px;
            background-color: var(--login-gold);
            border-radius: 10px;
            color: var(--login-black);
            padding: 0 10px;
            font-weight: bold;
        }

        .icon {
            position: absolute;
            top: 18px;
            right: 25px;
            font-size: 20px;
            color: rgba(255, 255, 255, 0.9);
        }

        #message {
            min-height: 20px;
            margin: 10px 0;
            text-align: center;
            font-weight: 600;
            text-shadow: 0px 0px 5px black;
            font-size: 0.9rem;
        }

        /* Login Button & Animations */
        .input-submit {
            width: 100%;
            height: 50px;
            background: #ececec;
            font-size: 16px;
            font-weight: bold;
            border: none;
            border-radius: 30px;
            cursor: pointer;
            transition: 0.3s;
            margin-top: 10px;
            color: black;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .input-submit:hover {
            background: var(--login-gold);
        }

        .input-submit.success {
            background-color: #2ecc71 !important;
            color: white;
            cursor: default;
        }

        .fa-check {
            animation: scaleIn 0.3s ease-out forwards;
        }

        .cart-footer {
            padding: 20px;
            border-top: 1px solid #ddd;
            background: white;
            /* Flexbox ensures perfect centering */
            display: flex;
            flex-direction: column;
            align-items: center; 
            justify-content: center;
        }

        .cart-total {
            font-weight: bold;
            font-size: 1.1rem; /* Slightly larger text */
            margin-bottom: 25px; /* Increased space between text and button */
            text-align: center;
            color: var(--dark);
        }

        @keyframes scaleIn {
            from { transform: scale(0); }
            to { transform: scale(1); }
        }

        .loading-dots {
            display: flex;
            gap: 5px;
        }

        .loading-dots span {
            width: 8px;
            height: 8px;
            background-color: black;
            border-radius: 50%;
            animation: bounce 1.4s infinite ease-in-out both;
        }

        .loading-dots span:nth-child(1) { animation-delay: -0.32s; }
        .loading-dots span:nth-child(2) { animation-delay: -0.16s; }

        @keyframes bounce {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1); }
        }

        /* ================= USER INTERFACE ================= */
        .inventory-container {
            display: flex;
            padding: 20px;
            gap: 20px;
            max-width: 1400px;
            margin: 0 auto;
            align-items: flex-start;
        }

        .sidebar {
            width: 250px;
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            position: sticky;
            top: 130px;
            height: fit-content;
            max-height: calc(100vh - 150px);
            overflow-y: auto;
        }

        .sidebar h3 {
            margin-bottom: 15px;
            border-bottom: 2px solid var(--primary);
            padding-bottom: 5px;
        }

        .cat-btn {
            display: block;
            width: 100%;
            padding: 10px;
            margin: 5px 0;
            border: none;
            background: #f4f4f4;
            text-align: left;
            cursor: pointer;
            border-radius: 5px;
            transition: 0.2s;
        }

        .cat-btn:hover, .cat-btn.active {
            background: var(--primary-light);
            font-weight: bold;
            border-left: 4px solid var(--primary);
        }

        .inventory-list {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        #inventory-items-container {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .inventory-header {
            display: flex;
            justify-content: space-between;
            background: var(--slate);
            color: white;
            padding: 15px;
            border-radius: 5px;
            font-weight: bold;
        }

        .header-right {
            display: flex;
            gap: 40px;
            width: 50%;
            justify-content: flex-end;
            padding-right: 40px;
        }

        .item-card {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: white;
            padding: 15px;
            border: 1px solid var(--border);
            border-radius: 5px;
            transition: 0.2s;
            animation: fadeInItem 0.3s ease-out forwards;
        }

        @keyframes fadeInItem {
            from { opacity: 0; transform: translateY(5px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .item-card:hover {
            border-color: var(--primary);
        }

        .item-name {
            font-size: 1.1rem;
            font-weight: 500;
        }

        .item-actions {
            display: flex;
            gap: 10px;
            align-items: center;
            width: 50%;
            justify-content: flex-end;
        }

        .item-actions input[type="number"] {
            width: 60px;
            padding: 5px;
            border: 1px solid #ccc;
            border-radius: 5px;
        }

        .item-actions input[type="text"] {
            width: 120px;
            padding: 5px;
            border: 1px solid #ccc;
            border-radius: 5px;
        }

        .add-btn {
            background: var(--slate);
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        .add-btn:hover {
            background: var(--dark);
        }

        .add-btn.success {
            background-color: #2ecc71 !important;
            transform: scale(1.1);
            pointer-events: none;
        }

        /* ================= OUT OF STOCK STYLES ================= */
        .item-card {
            position: relative; /* Needed for the overlay to sit inside */
            /* ... existing styles ... */
        }

        /* The Overlay Container */
        .oos-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.7); /* Whitewash effect */
            display: flex;
            justify-content: center;
            align-items: center;
            border-radius: 5px;
            z-index: 10;
            backdrop-filter: blur(1px);
        }

        /* The Text */
        .oos-text {
            background: #c0392b;
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 0.9rem;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            transform: rotate(-5deg); /* Stylish tilt */
        }

        /* Disable clicks on the content behind */
        .item-card.no-stock .item-info,
        .item-card.no-stock .item-actions {
            opacity: 0.4;
            pointer-events: none; /* Prevents clicking buttons */
        }

        /* ================= SLIDE-OUT CART ================= */
        #cart-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1040;
            opacity: 0;
            visibility: hidden;
            transition: 0.3s;
            backdrop-filter: blur(2px);
        }

        #cart-overlay.open {
            opacity: 1;
            visibility: visible;
        }

        #cart-sidebar {
            position: fixed;
            top: 0;
            right: 0;
            width: 400px;
            height: 100%;
            background: white;
            z-index: 1050;
            box-shadow: -5px 0 15px rgba(0, 0, 0, 0.1);
            transform: translateX(100%);
            transition: transform 0.3s ease-in-out;
            display: flex;
            flex-direction: column;
        }

        #cart-sidebar.open {
            transform: translateX(0);
        }

        .cart-header {
            padding: 20px;
            background: var(--dark);
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .close-cart-btn {
            background: none;
            border: none;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
        }

        .cart-items-scroll {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            background: #f9f9f9;
        }

        .sidebar-item {
            background: white;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 8px;
            border: 1px solid #eee;
            position: relative;
        }

        .sidebar-item h4 {
            font-size: 1rem;
            margin-bottom: 5px;
            color: var(--dark);
        }

        .sidebar-delete {
            position: absolute;
            top: 10px;
            right: 10px;
            color: #aaa;
            cursor: pointer;
            transition: 0.2s;
        }

        .sidebar-delete:hover {
            color: red;
        }

        .cart-footer {
            padding: 20px;
            border-top: 1px solid #ddd;
            background: white;
        }

        .checkout-btn {
            width: 100%;
            padding: 15px;
            background: var(--primary);
            color: var(--dark);
            border: none;
            border-radius: 5px;
            font-weight: bold;
            cursor: pointer;
            transition: 0.2s;
        }

        .checkout-btn:hover {
            background: #bfa030;
        }

        /* ================= CART EDITABLE QTY STYLES ================= */
        .sidebar-item-details {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 10px;
        }

        .qty-edit-input {
            width: 70px;
            padding: 5px;
            border: 1px solid var(--border);
            border-radius: 5px;
            text-align: center;
            font-weight: bold;
            color: var(--dark);
        }

        .unit-text {
            font-size: 0.9rem;
            color: #777;
            font-weight: 500;
        }

        /* ================= TOAST NOTIFICATIONS ================= */
        #toast-container {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 2000;
            display: flex;
            flex-direction: column;
            gap: 10px;
            pointer-events: none;
        }

        .toast {
            background: white;
            color: var(--dark);
            padding: 15px 20px;
            border-radius: 5px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            border-left: 5px solid var(--primary);
            display: flex;
            align-items: center;
            gap: 15px;
            min-width: 250px;
            pointer-events: auto;
            animation: slideInToast 0.3s ease-out forwards;
            font-weight: 500;
        }

        .toast.error {
            border-left-color: #e74c3c;
        }

        .toast.error i {
            color: #e74c3c;
        }

        .toast.success {
            border-left-color: #2ecc71;
        }

        .toast.success i {
            color: #2ecc71;
        }

        @keyframes slideInToast {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        @keyframes fadeOutToast {
            to { opacity: 0; transform: translateX(20px); }
        }

       /* ================= UPDATED ACCOUNT STYLES ================= */
       .account-container {
            display: flex;
            padding: 20px;
            gap: 30px;
            max-width: 1400px;
            margin: 0 auto;
            align-items: flex-start;
        }

        /* 1. Simplified Sidebar */
        .account-container {
            display: flex;
            padding: 20px;
            gap: 30px;
            max-width: 1400px;
            margin: 0 auto;
            align-items: flex-start;
        }

        .account-sidebar {
            width: 300px;
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
            position: sticky;
            top: 130px;
            text-align: left;
        }

        /* Clean Typography for Sidebar */
        .sidebar-name { font-size: 1.4rem; font-weight: bold; color: var(--primary); margin-bottom: 5px; }
        .sidebar-email { font-size: 0.9rem; color: #777; margin-bottom: 20px; word-break: break-all; }
        
        .sidebar-label { font-size: 0.75rem; font-weight: bold; color: #aaa; text-transform: uppercase; margin-bottom: 2px; }
        .sidebar-value { font-size: 1rem; color: var(--dark); font-weight: 500; margin-bottom: 15px; }

        .change-pass-btn {
            display: block;
            width: 100%;
            margin-top: 20px;
            padding: 10px;
            background: white;
            border: 1px solid var(--border);
            color: var(--dark);
            border-radius: 5px;
            cursor: pointer;
            font-weight: 600;
            transition: 0.2s;
            text-align: center;
        }
        .change-pass-btn:hover { background: var(--slate); color: white; border-color: var(--slate); }

        .history-header {
            display: flex;
            justify-content: space-between; /* Pushes Title to Left, Button to Right */
            align-items: center;
            width: 100%; /* Ensures the header spans the full width of the box */
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--primary);
        }

        .history-header h2 {
            color: var(--dark);
            font-size: 1.5rem;
            margin: 0; /* Remove default margin to prevent alignment issues */
        }

        /* ================= PASSWORD MODAL OVERLAY ================= */
        #pass-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 2000;
            display: flex; justify-content: center; align-items: center;
            opacity: 0; visibility: hidden; transition: 0.3s;
            backdrop-filter: blur(3px);
        }
        #pass-overlay.open { opacity: 1; visibility: visible; }

        .pass-modal {
            background: white;
            padding: 30px;
            width: 400px;
            border-radius: 10px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
            /* Slide Up Animation Setup */
            transform: translateY(50px); 
            transition: transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        
        #pass-overlay.open .pass-modal { transform: translateY(0); }

        .pass-header { font-size: 1.2rem; font-weight: bold; margin-bottom: 20px; color: var(--dark); border-bottom: 1px solid #eee; padding-bottom: 10px; }
        
        .modal-actions { display: flex; gap: 10px; margin-top: 20px; }
        .cancel-btn { flex: 1; padding: 10px; background: #eee; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; }
        .save-btn { flex: 1; padding: 10px; background: var(--primary); color: var(--dark); border: none; border-radius: 5px; cursor: pointer; font-weight: bold; }
        .save-btn:hover { background: #bfa030; }

        .pass-modal input {
            width: 100%;
            padding: 8px 10px; /* Reduced padding (Standard size) */
            height: 40px;      /* Force normal height (Overriding the 80px) */
            font-size: 1rem;
            border: 1px solid var(--border);
            border-radius: 5px;
            margin-top: 5px;
        }

        /* Adjust spacing between fields in the modal */
        .pass-modal .field-group {
            margin-bottom: 12px;
        }

        /* ================= ADMIN DASHBOARD ================= */
        .admin-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 20px;
        }

        .admin-title-row h2 {
            margin-bottom: 20px;
            font-size: 1.5rem;
            color: var(--dark);
        }

        .admin-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 25px;
            flex-wrap: wrap;
        }

        .tab-btn {
            padding: 10px 20px;
            background: white;
            border: 2px solid var(--dark);
            border-radius: 5px;
            font-weight: 600;
            cursor: pointer;
            transition: 0.2s;
        }

        .tab-btn:hover {
            background: #eee;
        }

        .tab-btn.active {
            background: var(--dark);
            color: white;
        }

        .admin-content-panel {
            display: none;
            animation: slideContentUp 0.4s ease-out;
        }

        .admin-content-panel.active {
            display: block;
        }

        .admin-table-container {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        }

        .admin-table {
            width: 100%;
            border-collapse: collapse;
        }

        .admin-table th {
            text-align: left;
            padding: 15px;
            border-bottom: 2px solid #eee;
            color: #777;
            font-size: 0.9rem;
            text-transform: uppercase;
        }

        .admin-table td {
            padding: 15px;
            border-bottom: 1px solid #eee;
            vertical-align: middle;
        }

        .status-badge {
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: bold;
        }

        .status-pending {
            background: #fff3cd;
            color: #856404;
        }

        .status-completed {
            background: #d4edda;
            color: #155724;
        }

        .status-rejected {
            background: #f8d7da;
            color: #721c24;
        }

        .view-btn {
            padding: 6px 15px;
            background: #ddd;
            border: 1px solid #ccc;
            border-radius: 5px;
            cursor: pointer;
        }

        /* Stock Cards */
        .stock-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }

        .stock-card {
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
            display: flex;
            flex-direction: column;
        }

        .stock-header {
            padding: 15px;
            text-align: center;
            color: white;
            font-weight: bold;
        }

        .stock-header.low {
            background: #c0392b;
        }

        .stock-header.mid {
            background: #b7950b;
        }

        .stock-header.high {
            background: #27ae60;
        }

        .stock-body {
            padding: 20px;
        }

        .stock-item-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px dashed #eee;
            font-size: 0.95rem;
        }

        .manage-btn-container {
            margin-top: 30px;
            text-align: right;
            border: 2px solid #2C3E50;
            padding: 20px;
            border-radius: 10px;
            background: white;
        }

        .google-sheet-btn {
            background: #546E7A;
            color: white;
            padding: 12px 25px;
            border: none;
            border-radius: 5px;
            font-weight: bold;
            cursor: pointer;
        }

        .google-sheet-btn:hover {
            background: #2C3E50;
        }

        .chart-container {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            height: 500px;
            position: relative;
        }

        /* ================= GRAPHICAL DASHBOARD STYLES ================= */
        .dashboard-filter-bar {
            background: white; padding: 15px 20px; border-radius: 8px;
            display: flex; gap: 30px; align-items: center; margin-bottom: 20px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        .filter-group { display: flex; align-items: center; gap: 10px; }
        .filter-group label { font-weight: bold; color: var(--dark); }
        .filter-group select { padding: 8px; border: 1px solid #ccc; border-radius: 5px; }

        /* Summary Cards (Blue Boxes) */
        .dashboard-summary-row {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px; margin-bottom: 20px;
        }
        .summary-card {
            background: #2C3E50; /* Solid Blue/Dark */
            color: white; padding: 20px; border-radius: 10px;
            display: flex; align-items: center; justify-content: center; gap: 20px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1); min-height: 120px;
        }
        .sum-icon { font-size: 3rem; color: var(--primary); }
        .sum-text h2 { font-size: 2.5rem; margin: 0; line-height: 1; }
        
        .summary-card ul { list-style: none; padding: 0; width: 100%; }
        .summary-card li { 
            border-bottom: 1px solid rgba(255,255,255,0.2); 
            padding: 5px 0; font-size: 0.9rem; 
            display: flex; justify-content: space-between;
        }
        .sum-list-header { font-weight: bold; color: var(--primary); margin-bottom: 10px; text-transform: uppercase; font-size: 0.8rem; }

        /* Charts Layout */
        .dashboard-grid-row {
            display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;
        }
        .chart-card {
            background: white; padding: 20px; border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }
        .chart-card.full-width { grid-column: span 2; }
        
        .chart-header-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .chart-wrapper { height: 300px; position: relative; width: 100%; }
        .chart-wrapper.large { height: 400px; }

        /* Responsive */
        @media (max-width: 900px) {
            .dashboard-grid-row { grid-template-columns: 1fr; }
            .chart-card.full-width { grid-column: span 1; }
        }

        /* ================= SLIP STYLES (Original Layout + New Features) ================= */
        .slip-container { 
            background: white; 
            padding: 40px; 
            border-radius: 10px; 
            box-shadow: 0 0 15px rgba(0,0,0,0.1); 
            /* Ensure it is centered and looks like a paper */
            max-width: 900px;
            margin: 0 auto;
        }

        /* Title inside the box (Original Style) */
        .slip-container h2 {
            margin-bottom: 20px;
            color: var(--dark);
            border-bottom: 2px solid var(--primary);
            padding-bottom: 10px;
        }

        .slip-header { 
            text-align: right; 
            margin-bottom: 20px; 
            background: var(--primary-light); 
            padding: 10px; 
            border-radius: 5px;
            font-weight: bold;
        }

        .form-section { margin-bottom: 20px; }
        .full-width-input { width: 100%; height: 80px; padding: 10px; border: 1px solid var(--border); border-radius: 5px; font-family: inherit; }

        .slip-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 40px; margin-top: 20px; }
        
        .field-group { margin-bottom: 15px; }
        .field-group label { display: block; margin-bottom: 5px; font-weight: bold; font-size: 0.9rem; }
        
        /* NEW: Style Selects to match Inputs perfectly */
        .field-group input, .field-group select { 
            width: 100%; 
            padding: 8px 10px; /* Match original padding */
            border: 1px solid var(--border); 
            border-radius: 5px; 
            background-color: white;
            font-size: 1rem;
        }

        /* Checkbox Area */
        .checkbox-group { 
            margin-top: 10px; 
            margin-bottom: 15px; 
            display: flex; 
            align-items: center; 
            gap: 8px;
            font-size: 0.9rem;
            color: #555;
        }

        /* Hidden Officer Section */
        #officer-fields {
            display: none; 
            padding: 15px;
            background: #f8f9fa; /* Very light grey to distinguish */
            border-radius: 5px;
            border: 1px dashed var(--border);
            animation: slideIn 0.3s ease-out;
        }
        @keyframes slideIn { from{opacity:0; transform:translateY(-10px);} to{opacity:1; transform:translateY(0);} }

        /* Editable Table Style */
        .slip-table { width: 100%; border-collapse: collapse; margin-top: 20px; font-size: 0.95rem; }
        .slip-table th { background: #eee; text-align: left; padding: 10px; border-bottom: 2px solid #ddd; }
        .slip-table td { border-bottom: 1px solid #eee; padding: 10px; vertical-align: middle; }
        
        .remove-icon {
            color: #e74c3c;
            cursor: pointer;
            font-size: 1rem;
            transition: 0.2s;
            background: none; border: none;
        }
        .remove-icon:hover { transform: scale(1.2); color: red; }

        .print-btn { display: block; width: 100%; margin-top: 30px; padding: 15px; background: var(--primary); border: none; font-size: 1.1rem; font-weight: bold; cursor: pointer; border-radius: 5px; }

        /* ================= SLIP FOOTER & CONFIRMATION ================= */
        .slip-footer-actions {
            display: flex;
            justify-content: flex-end; /* Align buttons to the right */
            align-items: center;
            gap: 15px;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid #eee;
        }

        /* Specific Button Styles for Footer */
        .slip-btn-back {
            padding: 12px 20px;
            background: white;
            border: 1px solid var(--border);
            color: var(--slate);
            border-radius: 5px;
            cursor: pointer;
            font-weight: 600;
            transition: 0.2s;
        }
        .slip-btn-back:hover { background: #f4f4f4; }

        .slip-btn-submit {
            padding: 12px 25px;
            background: var(--primary);
            border: none;
            color: var(--dark);
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            transition: 0.2s;
        }
        .slip-btn-submit:hover { background: #bfa030; transform: translateY(-2px); }

        /* Confirmation Overlay */
        #submit-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.6);
            z-index: 3000; /* Highest priority */
            display: flex; justify-content: center; align-items: center;
            opacity: 0; visibility: hidden; transition: 0.3s;
            backdrop-filter: blur(2px);
        }
        #submit-overlay.open { opacity: 1; visibility: visible; }

        .confirm-box {
            background: white;
            padding: 30px;
            width: 400px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            transform: scale(0.9); transition: 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        #submit-overlay.open .confirm-box { transform: scale(1); }

        .confirm-icon { font-size: 3rem; color: var(--primary); margin-bottom: 15px; }
        .confirm-title { font-size: 1.4rem; font-weight: bold; color: var(--dark); margin-bottom: 10px; }
        .confirm-desc { color: #666; margin-bottom: 25px; font-size: 0.95rem; }

        .confirm-actions { display: flex; gap: 10px; }
        .btn-cancel { flex: 1; padding: 10px; border: 1px solid #ccc; background: white; border-radius: 5px; cursor: pointer; font-weight: bold; }
        .btn-print { flex: 1; padding: 10px; border: none; background: var(--dark); color: white; border-radius: 5px; cursor: pointer; font-weight: bold; }
        .btn-print:hover { background: #1a252f; }

       /* ================= PRINT STYLES (DepEd Format) ================= */
        /* Hide the template by default on screen */
        #print-template { display: none; }

        #print-template { display: none; }

        @media print {
            /* Hide EVERYTHING except the template */
            body * { visibility: hidden; }
            #print-template, #print-template * { visibility: visible; }
            #print-template {
                position: absolute; left: 0; top: 0; width: 100%;
                font-family: 'Times New Roman', serif; color: black;
                display: block; box-sizing: border-box;
            }

            /* Header */
            .print-header { 
                display: flex; 
                justify-content: space-between; 
                align-items: center; 
                margin-bottom: 20px; 
                width: 100%;
            }
            .header-text p { margin: 2px 0; font-size: 10pt; }

            /* Main Table Structure */
            .ris-table {
                width: 100%; border-collapse: collapse;
                border: 2px solid black; /* Thick outer border */
                margin: 0; font-size: 10pt;
            }
            .ris-table th, .ris-table td {
                border: 1px solid black; padding: 4px;
            }
            .ris-table th { text-align: center; font-weight: bold; }
            
            /* Specific Alignment for Items */
            #print-items-body td:nth-child(1), /* Item No */
            #print-items-body td:nth-child(2), /* Unit */
            #print-items-body td:nth-child(4) { /* Qty */
                text-align: center;
            }

            /* Purpose Box (Merged visually with table) */
            .ris-purpose {
                border: 2px solid black; border-top: none; border-bottom: none;
                padding: 5px; font-size: 10pt; min-height: 25px;
            }

            /* Signatories Specifics */
            .signatories { border-top: 2px solid black; }
            .signatories td { vertical-align: middle; }

            /* Footer */
            .ris-footer { margin-top: 15px; font-size: 9pt; }
            .ris-footer p { margin: 2px 0; }
        }

        @media (max-width: 768px) {
            #navbar {
                padding: 0 10px;
            }
            .nav-center {
                display: none;
            }
            .sidebar {
                display: none;
            }
            .slip-grid {
                grid-template-columns: 1fr;
            }
        }

        /* ================= ADMIN VIEW MODAL ================= */
        #admin-view-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.6); z-index: 2000;
            display: flex; justify-content: center; align-items: center;
            opacity: 0; visibility: hidden; transition: 0.3s;
            backdrop-filter: blur(3px);
        }
        #admin-view-overlay.open { opacity: 1; visibility: visible; }

        .admin-modal {
            background: white; width: 800px; max-height: 90vh;
            border-radius: 10px; overflow-y: auto;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            display: flex; flex-direction: column;
            transform: scale(0.95); transition: 0.3s;
        }
        #admin-view-overlay.open .admin-modal { transform: scale(1); }

        .admin-modal-header {
            padding: 20px; background: var(--dark); color: white;
            display: flex; justify-content: space-between; align-items: center;
        }
        .admin-modal-body { padding: 30px; }

        /* Admin Action Buttons */
        .admin-actions {
            padding: 20px; border-top: 1px solid #eee; background: #f9f9f9;
            display: flex; justify-content: flex-end; gap: 10px;
        }
        .btn-reject { background: #e74c3c; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; font-weight: bold; }
        .btn-approve { background: #2ecc71; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; font-weight: bold; }
        .btn-print-admin { background: var(--primary); color: var(--dark); border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; font-weight: bold; }
        
        /* Readonly fields in modal */
        .modal-label { font-size: 0.8rem; font-weight: bold; color: #888; text-transform: uppercase; }
        .modal-value { font-size: 1.1rem; font-weight: 500; margin-bottom: 15px; color: var(--dark); border-bottom: 1px solid #eee; padding-bottom: 5px;}


    </style>
</head>
<body>

    <!-- ================= SIDEBAR CART & OVERLAY ================= -->
    <div id="cart-overlay" onclick="toggleCart()"></div>
    <aside id="cart-sidebar">
        <div class="cart-header">
            <h3><i class="fa-solid fa-cart-shopping"></i> My Cart</h3>
            <button class="close-cart-btn" onclick="toggleCart()"><i class="fa-solid fa-xmark"></i></button>
        </div>
        <div id="cart-sidebar-items" class="cart-items-scroll"></div>
        <div class="cart-footer">
            <div class="cart-total">Total Items: <span id="sidebar-total-count">0</span></div>
            <button onclick="proceedToRequisition()" class="checkout-btn">Proceed to Slip</button>
        </div>
    </aside>

    <!-- ================= NAVBAR (USER) ================= -->
    <nav id="navbar" class="hidden">
        <div class="nav-left">
            <a href="#" onclick="navigate('user-interface')" class="logo-btn">
                <img src="logo.png" class="logoheh" alt="Logo">
                <img src="sight-removebg-preview.png" class="sightlogo" alt="Sight">
            </a>
        </div>
        <div class="nav-center">
            <div class="search-container">
                <div class="search-wrapper">
                    <input type="text" id="searchInput" placeholder="Search for products..." oninput="handleSearch()" autocomplete="off">
                    <button class="search-btn" onclick="handleSearch()"><i class="fa-solid fa-magnifying-glass"></i></button>
                </div>
            </div>
        </div>
        <div class="nav-right">
            <a href="#" onclick="toggleCart()" class="nav-icon" title="Cart"><i class="fa-solid fa-cart-shopping"></i><span id="cart-count">0</span></a>
            <a href="#" onclick="navigate('account-page')" class="nav-icon" title="Account"><i class="fa-solid fa-user"></i></a>
            <a href="#" onclick="logout()" class="nav-logout-btn">Logout</a>
        </div>
    </nav>

    <!-- ================= PAGE 1: LOGIN ================= -->
    <section id="login-page" class="page active">
        <div class="wrapper">
            <div class="login_box">
                <div class="login-header"><span>Login</span></div>
                <form id="loginForm" onsubmit="handleLogin(event)" autocomplete="on">
                    <div class="input_box">
                        <input type="text" id="email" class="input-field" placeholder=" " required>
                        <label for="email" class="label">Email</label>
                        <i class="bx bx-user icon"></i>
                    </div>
                    <div class="input_box">
                        <input type="password" id="password" class="input-field" placeholder=" " required>
                        <label for="password" class="label">Password</label>
                        <i class="bx bx-lock-alt icon"></i>
                    </div>
                    <div id="message" aria-live="polite"></div>
                    <div class="input_box">
                        <button type="submit" id="submitBtn" class="input-submit">Log In</button>
                    </div>
                </form>
            </div>
        </div>
    </section>

    <!-- ================= PAGE 2: USER INTERFACE ================= -->
    <section id="user-interface" class="page hidden">
        <div class="inventory-container">
            <aside class="sidebar">
                <h3>Office Supplies</h3>
                <button class="cat-btn active" onclick="filterCategory('all', this)">All</button>
                <button class="cat-btn" onclick="filterCategory('Folders', this)">Folders, Envelopes & Storage</button>
                <button class="cat-btn" onclick="filterCategory('Paper', this)">Paper Products</button>
                <button class="cat-btn" onclick="filterCategory('Inks', this)">Inks & Toners</button>
                <button class="cat-btn" onclick="filterCategory('Writing', this)">Writing Instruments</button>
                <button class="cat-btn" onclick="filterCategory('Adhesives', this)">Adhesives</button>
                <button class="cat-btn" onclick="filterCategory('IT', this)">IT Accessories</button>
                <button class="cat-btn" onclick="filterCategory('Electrical', this)">Power & Electrical</button>
                <button class="cat-btn" onclick="filterCategory('General', this)">General Supplies</button>
            </aside>
            <main class="inventory-list">
                <div class="inventory-header">
                    <div>Description</div>
                    <div class="header-right"><span>Qty</span><span>Unit</span><span>Notes</span><span>Action</span></div>
                </div>
                <div id="inventory-items-container"></div>
            </main>
        </div>
    </section>

    <!-- ================= PAGE 2.3: SLIP (Original Layout + New Logic) ================= -->
    <section id="requisition-page" class="page hidden">
        <div class="container">
            <div class="slip-container">
                <!-- 1. Title Inside (Original) -->
                <h2>Fill up the Requisition and Issue Slip</h2>
                
                <!-- 2. Auto Date -->
                <div class="slip-header">
                    <label>Date: <span id="slip-date"></span></label>
                </div>

                <div class="form-section">
                    <label style="font-weight:bold;">Purpose of the request:</label>
                    <textarea id="req-purpose" class="full-width-input" placeholder="Enter the purpose here..."></textarea>
                </div>

                <div class="slip-grid">
                    <!-- LEFT COLUMN -->
                    <div class="slip-column">
                        <h4 style="color:var(--slate); margin-bottom:15px; text-transform:uppercase; font-size:0.9rem;">Requestor's Information</h4>
                        
                        <div class="field-group">
                            <label>Section / Unit:</label>
                            <!-- Auto-filled & Readonly -->
                            <input type="text" id="req-section" readonly style="background:#f4f4f4; color:#555; cursor:not-allowed;">
                        </div>

                        <div class="field-group">
                            <label>Name:</label>
                            <input type="text" id="req-name" readonly style="background:#f4f4f4; color:#555; cursor:not-allowed;">
                        </div>

                        <div class="field-group">
                            <label>Designation:</label>
                            <!-- Auto-filled & Readonly -->
                            <input type="text" id="req-designation" readonly style="background:#f4f4f4; color:#555; cursor:not-allowed;">
                        </div>
                    </div>

                    <!-- RIGHT COLUMN -->
                    <div class="slip-column">
                        <h4 style="color:var(--slate); margin-bottom:15px; text-transform:uppercase; font-size:0.9rem;">Approved By</h4>
                        
                        <div class="field-group">
                            <label>Approver Name:</label>
                            <!-- Auto-filled & Readonly -->
                            <input type="text" id="app-name" readonly style="background:#f4f4f4; color:#555; cursor:not-allowed;">
                        </div>

                        <!-- Checkbox Logic -->
                        <div class="checkbox-group">
                            <input type="checkbox" id="not-present" onchange="toggleOfficerFields()">
                            <label for="not-present">Use Officer of the Day</label>
                        </div>

                        <!-- Hidden Fields -->
                        <div id="officer-fields">
                            <h5 style="margin-bottom:10px; color:var(--dark);">Officer of the Day Details:</h5>
                            <div class="field-group">
                                <input type="text" id="off-name" placeholder="Full Name">
                            </div>
                            <div class="field-group">
                                <input type="text" id="off-designation" placeholder="Designation">
                            </div>
                        </div>
                    </div>
                </div>

                    <!-- 3. Editable Items Table -->
                    <h4 style="margin-top:30px; border-bottom:1px solid #ddd; padding-bottom:5px;">Requested Items</h4>
                    <div id="slip-items-render-area">
                        <!-- JS will put the table here -->
                    </div>

                    <div class="slip-footer-actions">
                    <button onclick="navigate('cart-page')" class="slip-btn-back">
                        Back to Cart
                    </button>
                    <button onclick="validateAndShowConfirm()" class="slip-btn-submit">
                        Submit Request
                    </button>
                </div>
            </div>
        </div> 
    </section>

    <!-- ================= SUBMIT CONFIRMATION OVERLAY ================= -->
    <div id="submit-overlay">
        <div class="confirm-box">
            <div class="confirm-icon"><i class="fa-solid fa-file-circle-question"></i></div>
            <div class="confirm-title">Confirm Request</div>
            <div class="confirm-desc">
                Are you sure you want to submit this requisition? This will record the transaction and open the print dialog.
            </div>
            <div class="confirm-actions">
                <button onclick="closeSubmitConfirm()" class="btn-cancel">Cancel</button>
                <button onclick="finalizeAndPrint()" class="btn-print">
                    <i class="fa-solid fa-print"></i> Print
                </button>
            </div>
        </div>
    </div>

    <!-- ================= PAGE 2.2: ACCOUNT ================= -->
    <section id="account-page" class="page hidden">
        <div class="account-container">
            
            <!-- SIDEBAR: Requested Info Only -->
            <aside class="account-sidebar">
                <div class="sidebar-name" id="acc-sidebar-name">Loading...</div>
                <div class="sidebar-email" id="acc-sidebar-email">--</div>
                
                <hr style="border:0; border-top:1px solid #eee; margin: 15px 0;">

                <div class="sidebar-label">Department / Unit</div>
                <div class="sidebar-value" id="acc-sidebar-dept">--</div>

                <div class="sidebar-label">Designation</div>
                <div class="sidebar-value" id="acc-sidebar-desig">--</div>

                <!-- Change Password Trigger -->
                <button onclick="togglePasswordModal()" class="change-pass-btn">
                    <i class="fa-solid fa-lock"></i> Change Password
                </button>
            </aside>

            <!-- MAIN: HISTORY -->
            <div class="account-box" style="flex:1;">
                <div class="history-header">
                    <h2><i class="fa-solid fa-clock-rotate-left"></i> Transaction History</h2>
                    <button onclick="fetchUserTransactions()" style="background:none; border:none; cursor:pointer; color:var(--slate);">
                        <i class="fa-solid fa-rotate-right"></i> Refresh
                    </button>
                </div>
                <table class="admin-table">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Request ID</th>
                            <th>Items</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody id="user-history-body"></tbody>
                </table>
            </div>
        </div>
    </section>

    <!-- ================= PASSWORD OVERLAY (HIDDEN) ================= -->
    <div id="pass-overlay">
        <div class="pass-modal">
            <div class="pass-header">Change Password</div>
            
            <div class="field-group">
                <label>Current Password</label>
                <input type="password" id="current-pass" class="full-width-input">
            </div>
            
            <div class="field-group">
                <label>New Password</label>
                <input type="password" id="new-pass" class="full-width-input">
            </div>
            
            <div class="field-group">
                <label>Confirm New Password</label>
                <input type="password" id="confirm-pass" class="full-width-input">
            </div>

            <div class="modal-actions">
                <button onclick="togglePasswordModal()" class="cancel-btn">Cancel</button>
                <button onclick="handleChangePassword()" class="save-btn">Update</button>
            </div>
        </div>
    </div>

    <!-- ================= PAGE 3: ADMIN DASHBOARD ================= -->
    <section id="officer-dashboard" class="page hidden">
        
        <!-- ADMIN HEADER (Reusing Background Image) -->
        <div class="admin-header">
            <div class="nav-left">
                <div class="logo-btn">
                    <img src="logo.png" class="logoheh" alt="Logo">
                    <img src="sight-removebg-preview.png" class="sightlogo" alt="Sight">
                </div>
                <span style="font-size:1.5rem; font-weight:800; color:var(--dark); margin-left:10px; text-shadow:1px 1px 0 #fff;">ADMIN</span>
            </div>
            <a href="#" onclick="logout()" class="nav-logout-btn">Logout</a>
        </div>

        <div class="admin-container">
            <div class="admin-title-row"><h2>Admin Dashboard - Supplies Inventory</h2></div>

            <!-- Tabs: Default Charts first -->
            <div class="admin-tabs">
                <button class="tab-btn" onclick="switchAdminTab('tab-charts', this)">Graphical Dashboard</button>
                <button class="tab-btn" onclick="switchAdminTab('tab-pending', this)">Pending Requests</button>
                <button class="tab-btn" onclick="switchAdminTab('tab-stocks', this)">Stock Status</button>
                <button class="tab-btn" onclick="switchAdminTab('tab-logs', this)">Activity Log</button>
            </div>

            <!-- TAB 1: GRAPHICAL DASHBOARD (Revamped) -->
            <div id="tab-charts" class="admin-content-panel">
                
                <!-- 1. GLOBAL FILTERS -->
                <div class="dashboard-filter-bar">
                    <div class="filter-group">
                        <label>Year:</label>
                        <select id="dash-date-filter" onchange="updateDashboard()">
                            <option value="all">All Time</option>
                            <option value="2025" selected>2025</option>
                            <option value="2024">2024</option>
                            <option value="2023">2023</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>Section / Unit:</label>
                        <select id="dash-unit-filter" onchange="updateDashboard()">
                            <option value="all">All Units</option>
                            <option value="Administrative Unit">Administrative Unit</option>
                            <option value="Cash Section">Cash Section</option>
                            <option value="Supply Section">Supply Section</option>
                            <option value="Records Section">Records Section</option>
                            <option value="Personnel Section">Personnel Section</option>
                            <option value="Budget Unit">Budget Unit</option>
                            <option value="Accounting Unit">Accounting Unit</option>
                            <option value="ICT Unit">ICT Unit</option>
                            <option value="Legal Unit">Legal Unit</option>
                            <option value="Instructional Management Section">Instructional Management Section</option>
                            <option value="ALS">ALS</option>
                            <option value="PSDS">PSDS</option>
                            <option value="LRMS">LRMS</option>
                            <option value="SGOD">SGOD</option>
                            <option value="SMM&E">SMM&E</option>
                            <option value="HRD">HRD</option>
                            <option value="Education Facilities Section">Education Facilities Section</option>
                            <option value="Planning & Research Section">Planning & Research Section</option>
                            <option value="Schools Health Section">Schools Health Section</option>
                            <option value="SMNS">SMNS</option>
                            <option value="SGOD Clerk & Staff">SGOD Clerk & Staff</option>
                            <option value="CID & PSDS Clerk & Staff">CID & PSDS Clerk & Staff</option>
                        </select>
                    </div>
                </div>

                <!-- 2. SUMMARY CARDS (Blue Boxes) -->
                <div class="dashboard-summary-row">
                    <!-- Total Requests -->
                    <div class="summary-card">
                        <div class="sum-icon"><i class="fa-solid fa-hand-holding-hand"></i></div>
                        <div class="sum-text">
                            <h2 id="sum-total-req">0</h2>
                            <p>Total Requests</p>
                        </div>
                    </div>
                    <!-- Top Items -->
                    <div class="summary-card">
                        <div class="sum-list-header">Top Requested Items</div>
                        <ul id="sum-top-items">
                            <!-- JS injected -->
                        </ul>
                    </div>
                    <!-- Top Units -->
                    <div class="summary-card">
                        <div class="sum-list-header">Top 3 Requestors</div>
                        <ul id="sum-top-units">
                            <!-- JS injected -->
                        </ul>
                    </div>
                </div>

                <!-- 3. ROW 1: LINE GRAPH & DONUT -->
                <div class="dashboard-grid-row">
                    <div class="chart-card">
                        <h3>Request Volume Over Time</h3>
                        <div class="chart-wrapper">
                            <canvas id="chartVolume"></canvas>
                        </div>
                    </div>
                    <div class="chart-card">
                        <h3>Category Usage</h3>
                        <div class="chart-wrapper">
                            <canvas id="chartCategory"></canvas>
                        </div>
                    </div>
                </div>

                <!-- 4. ROW 2: HORIZONTAL BAR (Most Requested Items) -->
                <div class="dashboard-grid-row">
                    <div class="chart-card full-width">
                        <div class="chart-header-row">
                            <h3>Most Requested Items</h3>
                            <select id="dash-cat-filter" onchange="updateBarChart()">
                                <option value="all">All Categories</option>
                                <option value="Folders">Folders & Storage</option>
                                <option value="Paper">Paper Products</option>
                                <option value="Inks">Inks & Toners</option>
                                <option value="Writing">Writing Instruments</option>
                                <option value="IT">IT Accessories</option>
                            </select>
                        </div>
                        <div class="chart-wrapper large">
                            <canvas id="chartItemsBar"></canvas>
                        </div>
                    </div>
                </div>

                <!-- 5. ROW 3: STOCK TRENDS (Predictive Search) -->
                <div class="dashboard-grid-row">
                    <div class="chart-card full-width">
                        <div class="chart-header-row">
                            <h3>Item Demand Trend</h3>
                            <div class="search-predict-wrapper">
                                <input type="text" id="dash-item-search" placeholder="Search item..." oninput="predictItemSearch()" list="items-datalist">
                                <datalist id="items-datalist">
                                    <!-- Options injected via JS -->
                                </datalist>
                            </div>
                        </div>
                        <div class="chart-wrapper">
                            <canvas id="chartItemTrend"></canvas>
                        </div>
                    </div>
                </div>

            </div>

            <!-- Tab 2: Pending -->
            <div id="tab-pending" class="admin-content-panel">
                <div class="admin-table-container">
                    <h3>Pending Requests</h3><br>
                    <table class="admin-table">
                        <thead><tr><th>Date</th><th>Requestor</th><th>Section/Unit</th><th>Status</th><th>Action</th></tr></thead>
                        <tbody id="pending-table-body"></tbody>
                    </table>
                </div>
            </div>

            <!-- Tab 3: Stocks -->
            <div id="tab-stocks" class="admin-content-panel">
                <div class="stock-grid">
                    <div class="stock-card"><div class="stock-header low">Low Stock Items (< 15)</div><div class="stock-body" id="stock-low-list"></div></div>
                    <div class="stock-card"><div class="stock-header mid">Items Nearing Low (15 - 40)</div><div class="stock-body" id="stock-mid-list"></div></div>
                    <div class="stock-card"><div class="stock-header high">Sufficient (Still OK)</div><div class="stock-body" id="stock-high-list"></div></div>
                </div>
                <div class="manage-btn-container">
                    <h4 style="display:inline-block; margin-right:20px;">Want to edit stocks?</h4>
                    <button class="google-sheet-btn" onclick="openGoogleSheet()">Manage Supplies Stocks (Google Sheets)</button>
                </div>
            </div>

            <!-- Tab 4: Logs -->
            <div id="tab-logs" class="admin-content-panel">
                <div class="admin-table-container">
                    <h3>Activity History</h3><br>
                    <table class="admin-table">
                        <thead><tr><th>Date</th><th>Requestor</th><th>Items</th><th>Status</th></tr></thead>
                        <tbody id="logs-table-body"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </section>

    <!-- Toast Notification Container -->
    <div id="toast-container"></div>

    <!-- ================= HIDDEN PRINT TEMPLATE (Exact DepEd Format) ================= -->
    <div id="print-template">
        
        <!-- Header -->
        <div class="print-header">
            <div style="flex: 1; text-align: right;">
                <img src="deped.png" style="width: 80px; height: 80px;">
            </div>
            
            <div class="header-text" style="flex: 2; text-align: center;">
                <p style="font-family: 'Times New Roman', serif; margin: 0;">Republic of the Philippines</p>
                <p style="font-family: 'Times New Roman', serif; margin: 0;">DEPARTMENT OF EDUCATION</p>
                <p style="font-weight:bold; font-size:12pt; margin: 5px 0;">SCHOOLS DIVISION OFFICE</p>
                <p style="font-family: 'Times New Roman', serif; margin: 0;">City of Mandaluyong</p>
            </div>

            <div style="flex: 1; text-align: left;">
                <img src="logo.png" style="width: 80px; height: 80px;"> 
            </div>
        </div>

        <!-- TITLE: Removed Underline -->
        <h2 style="text-align:center; margin: 20px 0 10px 0; font-family: 'Times New Roman', serif; font-size: 16pt; font-weight: bold;">REQUISITION AND ISSUE SLIP</h2>

        <!-- SECTION: Aligned Underline -->
        <div style="margin-bottom: 5px; font-family: 'Times New Roman', serif; font-size: 11pt;">
            <strong>Section / Unit :</strong> 
            <span id="print-section" style="
                border-bottom: 1px solid black; 
                padding: 0 10px; 
                display: inline-block; 
                min-width: 250px; 
                text-align: center;
                vertical-align: bottom; /* Ensures line aligns with text baseline */
                font-weight: bold;
            "></span>
        </div>

        <!-- MAIN TABLE -->
        <table class="ris-table">
            <thead>
                <tr>
                    <th colspan="4" style="font-style: italic;">Requisition</th>
                    <th colspan="2" style="font-style: italic;">Stock Available?</th>
                    <th colspan="2" style="font-style: italic;">Issue</th>
                </tr>
                <tr>
                    <th style="width: 6%;">Item No.</th>
                    <th style="width: 6%;">Unit</th>
                    <th style="width: 38%;">Description</th>
                    <th style="width: 8%;">Quantity</th>
                    <th style="width: 5%;">Yes</th>
                    <th style="width: 5%;">No</th>
                    <th style="width: 8%;">Quantity</th>
                    <th style="width: 24%;">Remarks</th>
                </tr>
            </thead>
            <tbody id="print-items-body">
                <!-- Items injected via JS -->
            </tbody>
        </table>
        
        <div class="ris-purpose">
            <strong>Purpose:</strong> <span id="print-purpose"></span>
        </div>

        <!-- SIGNATORIES TABLE -->
        <table class="ris-table signatories">
            <tr>
                <td style="width: 12%; border:none;"></td>
                <td style="width: 29%; font-weight:bold;">Requested by:</td>
                <td style="width: 29%; font-weight:bold;">Approved by:</td>
                <td style="width: 15%; font-weight:bold;">Issued by:</td>
                <td style="width: 15%; font-weight:bold;">Received by:</td>
            </tr>
            <tr style="height: 50px;">
                <td style="text-align:center;">Signature:</td>
                <td></td> <td></td> <td></td> <td></td>
            </tr>
            <tr>
                <td style="text-align:center;">Printed Name:</td>
                <td style="text-align:center; font-weight:bold; text-transform:uppercase;" id="print-req-name"></td>
                <td style="text-align:center; font-weight:bold; text-transform:uppercase;" id="print-app-name"></td>
                <td></td> <td></td>
            </tr>
            <tr>
                <td style="text-align:center;">Designation:</td>
                <td style="text-align:center;" id="print-req-designation"></td>
                <td style="text-align:center;" id="print-app-designation"></td>
                <td></td> <td></td>
            </tr>
            <tr>
                <td style="text-align:center;">Date:</td>
                <td style="text-align:center;" id="print-req-date"></td>
                <td></td> <td></td> <td></td>
            </tr>
        </table>

        <div class="ris-footer">
            <p>Effective Date: &nbsp;&nbsp;&nbsp; April 23, 2018</p>
            <p>Document No.: &nbsp;&nbsp;&nbsp; ADM-SPF-001 Rev. No.: 00</p>
        </div>
    </div>

    <!-- ================= ADMIN VIEW REQUEST MODAL ================= -->
    <div id="admin-view-overlay">
        <div class="admin-modal">
            <div class="admin-modal-header">
                <h3>Request Details</h3>
                <button onclick="closeAdminModal()" style="background:none; border:none; color:white; font-size:1.5rem; cursor:pointer;"><i class="fa-solid fa-xmark"></i></button>
            </div>
            
            <div class="admin-modal-body">
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:20px;">
                    <div>
                        <div class="modal-label">Request ID</div>
                        <div class="modal-value" id="view-id">--</div>
                    </div>
                    <div>
                        <div class="modal-label">Date</div>
                        <div class="modal-value" id="view-date">--</div>
                    </div>
                    <div>
                        <div class="modal-label">Requestor Name</div>
                        <div class="modal-value" id="view-name">--</div>
                    </div>
                    <div>
                        <div class="modal-label">Unit / Section</div>
                        <div class="modal-value" id="view-unit">--</div>
                    </div>
                </div>

                <div class="modal-label" style="margin-top:10px;">Purpose</div>
                <div class="modal-value" id="view-purpose">--</div>

                <h4 style="margin-top:20px; border-bottom:2px solid var(--primary); padding-bottom:5px;">Requested Items (Editable)</h4>
                <table class="admin-table">
                    <thead>
                        <tr>
                            <th>Item Name</th>
                            <th>Qty</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody id="view-items-body">
                        <!-- Items injected here -->
                    </tbody>
                </table>
            </div>

            <div class="admin-actions">
                <button class="btn-print-admin" onclick="printAdminSlip()">
                    <i class="fa-solid fa-print"></i> Print Slip
                </button>
                <div style="flex:1;"></div> <!-- Spacer -->
                <button class="btn-reject" onclick="updateRequestStatus('Rejected')">Reject</button>
                <button class="btn-approve" onclick="updateRequestStatus('Completed')">Approve</button>
            </div>
        </div>
    </div>

    <!-- ================= JAVASCRIPT ================= -->
    <script>
        // Force scroll to top on refresh
        if (history.scrollRestoration) history.scrollRestoration = 'manual';

        //  CONFIGURATION: Paste your Google Script Web App URL here
        const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbyntXkX1b3nGSpydUbml1qA0ZROmO_99HJka62HJq2sGLkIcvusI1f4MNB7uxk_o2HC/exec';

        // ================= DATA VARIABLES =================
        // REMOVED: Mock Data
        // ADDED: Empty array to be filled by Google Sheets
        let inventoryDB = [];

        let cart = [];
        let currentUser = null;
        let currentCategory = 'all';
        let searchQuery = '';

        // Wake Up Server (Frontend ping)
        (function wakeUpServer() {
            if(WEB_APP_URL.includes('script.google.com')) {
                fetch(WEB_APP_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify({ action: "ping" }) })
                .catch(e => console.log("Wake-up silent fail"));
            }
        })();

        // ================= INITIALIZATION =================
        document.addEventListener('DOMContentLoaded', () => {
            const savedSession = localStorage.getItem('sightSession');
            const savedCart = localStorage.getItem('sightCart');
            const lastPage = localStorage.getItem('sightLastPage');

            // 1. Fetch Data immediately
            fetchInventory(); 

            // 2. Restore Cart
            if(savedCart) { cart = JSON.parse(savedCart); updateCartCount(); }

            // 3. Restore User & Location
            if (savedSession) {
                currentUser = JSON.parse(savedSession);
                updateUIWithUser();
                
                if (currentUser.role === 'admin') { 
                    navigate('officer-dashboard'); 
                    initAdminDashboard(); 
                } else {
                    const validPages = ['user-interface', 'requisition-page', 'account-page'];
                    if (lastPage && validPages.includes(lastPage)) navigate(lastPage);
                    else navigate('user-interface');
                }
            }
        });

        // ================= FETCH INVENTORY (CACHE FIRST STRATEGY) =================
        function fetchInventory() {
            const container = document.getElementById('inventory-items-container');
            
            // 1. CHECK CACHE (Instant Load)
            const cachedInventory = localStorage.getItem('sightInventoryCache');
            
            if (cachedInventory) {
                // If we have data saved, load it IMMEDIATELY
                inventoryDB = JSON.parse(cachedInventory);
                
                // Render UI immediately without waiting for Google
                if(container && !container.innerHTML) renderInventory();
                if(document.getElementById('officer-dashboard').classList.contains('active')) renderStockStatus();
                
                console.log("Loaded from Cache (Instant)");
            } else {
                // Only show loading animation if we have NO cache (First time user)
                if(container) {
                    container.innerHTML = `
                        <div style="text-align:center; padding:40px;">
                            <div class="loading-dots" style="justify-content:center; margin-bottom:10px;">
                                <span></span><span></span><span></span>
                            </div>
                            <p style="color:#777;">Loading Inventory...</p>
                        </div>`;
                }
            }

            // 2. FETCH FRESH DATA (Background Update)
            if(WEB_APP_URL.includes('script.google.com')) {
                fetch(WEB_APP_URL, {
                    method: 'POST',
                    body: JSON.stringify({ action: "getInventory" })
                })
                .then(response => response.json())
                .then(data => {
                    // Check if data actually changed to avoid unnecessary re-renders
                    if (JSON.stringify(data) !== cachedInventory) {
                        console.log("New data detected, updating...");
                        inventoryDB = data; 
                        
                        // SAVE TO CACHE for next time
                        localStorage.setItem('sightInventoryCache', JSON.stringify(data));
                        
                        // Update UI
                        if(document.getElementById('inventory-items-container')) renderInventory();
                        if(document.getElementById('officer-dashboard') && !document.getElementById('officer-dashboard').classList.contains('hidden')) renderStockStatus();
                    } else {
                        console.log("Data is up to date.");
                    }
                })
                .catch(err => {
                    console.error("Fetch Error:", err);
                    if(!cachedInventory && container) {
                        container.innerHTML = '<p style="text-align:center; color:red;">Failed to load. Please refresh.</p>';
                    }
                });
            }
        }
        // Navigation Logic
        function navigate(pageId) {
            document.querySelectorAll('.page').forEach(page => page.classList.add('hidden'));
            document.querySelectorAll('.page').forEach(page => page.classList.remove('active'));
            const target = document.getElementById(pageId);
            if(target) { target.classList.remove('hidden'); target.classList.add('active'); }

            const navbar = document.getElementById('navbar');
            if(pageId === 'login-page' || pageId === 'officer-dashboard') navbar.classList.add('hidden');
            else navbar.classList.remove('hidden');

            if(pageId === 'user-interface') renderInventory();
            if(pageId === 'requisition-page') prepareSlip();
            if(pageId === 'account-page') fetchUserTransactions();

            // Save location logic (except for login/admin)
            if (pageId !== 'login-page' && pageId !== 'officer-dashboard') {
                localStorage.setItem('sightLastPage', pageId);
            }
        }

        // Login Handler
        function handleLogin(e) {
            e.preventDefault();
            const email = document.getElementById('email').value.trim();
            const password = document.getElementById('password').value;
            const message = document.getElementById('message');
            const submitBtn = document.getElementById('submitBtn');

            if (!email || !password) { message.style.color = 'red'; message.textContent = 'Enter email and password.'; return; }
            message.textContent = ''; 
            submitBtn.disabled = true; submitBtn.style.opacity = '1';
            submitBtn.innerHTML = `<div class="loading-dots"><span></span><span></span><span></span></div>`;

            const triggerSuccess = (user) => {
                submitBtn.className = 'input-submit success';
                submitBtn.innerHTML = '<i class="fa-solid fa-check"></i>';
                currentUser = user;
                localStorage.setItem('sightSession', JSON.stringify(currentUser)); 
                updateUIWithUser(); // This will auto-fill the slip logic too
                setTimeout(() => {
                    if(currentUser.role === 'admin') { navigate('officer-dashboard'); initAdminDashboard(); }
                    else navigate('user-interface');
                    setTimeout(() => resetLogin(submitBtn, message), 500); 
                }, 500); 
            };

            if(WEB_APP_URL.includes('script.google.com')) {
                // REAL BACKEND LOGIN
                fetch(WEB_APP_URL, { method: 'POST', body: JSON.stringify({ email: email, password: password }) })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        // Ensure your Google Sheet sends these new fields back!
                        triggerSuccess({ 
                            name: data.name, 
                            role: data.role, 
                            email: data.email, 
                            dept: data.dept, 
                            designation: data.designation, // NEW
                            approver: data.approver        // NEW
                        });
                    } else { 
                        message.style.color = 'red'; message.textContent = 'Invalid credentials.'; resetLogin(submitBtn, message, false); 
                    }
                })
                .catch(err => { message.style.color = 'red'; message.textContent = 'Connection error.'; resetLogin(submitBtn, message, false); });
            } else {
                // DEMO MODE (With auto-fill data)
                setTimeout(() => {
                    if(email.includes('admin')) {
                        triggerSuccess({ name: "Officer One", role: "admin", email: email, dept: "Supply Office", designation: "Supply Officer", approver: "Superintendent" });
                    } else {
                        triggerSuccess({ 
                            name: "Juan Dela Cruz", 
                            role: "user", 
                            email: email, 
                            dept: "ICT Department",       // Auto-filled Section
                            designation: "Admin Aide VI", // Auto-filled Designation
                            approver: "Hanna B. Salvo"    // Auto-filled Approver
                        });
                    }
                }, 500);
            }
        }

        function resetLogin(btn, msg, clearMsg=true) {
            btn.disabled = false; btn.className = 'input-submit'; btn.innerHTML = 'Log In';
            if(clearMsg) msg.textContent = '';
        }

        function updateUIWithUser() {
            if(!currentUser) return;
            
            // Slip Auto-fill
            if(document.getElementById('req-name')) {
                document.getElementById('req-name').value = currentUser.name;
                document.getElementById('req-section').value = currentUser.dept || '';
                document.getElementById('req-designation').value = currentUser.designation || '';
                document.getElementById('app-name').value = currentUser.approver || '';
            }

            // NEW Sidebar IDs
            if(document.getElementById('acc-sidebar-name')) {
                document.getElementById('acc-sidebar-name').innerText = currentUser.name;
                document.getElementById('acc-sidebar-email').innerText = currentUser.email;
                document.getElementById('acc-sidebar-dept').innerText = currentUser.dept || 'N/A';
                document.getElementById('acc-sidebar-desig').innerText = currentUser.designation || 'N/A';
            }
        }

        // ================= FETCH USER HISTORY =================
        function fetchUserTransactions() {
            const tbody = document.getElementById('user-history-body');
            if(!tbody) return;

            tbody.innerHTML = '<tr><td colspan="4" style="text-align:center;">Loading history...</td></tr>';

            // 1. REAL FETCH (If URL exists)
            if(WEB_APP_URL.includes('script.google.com')) {
                fetch(WEB_APP_URL, {
                    method: 'POST',
                    body: JSON.stringify({ 
                        action: "getUserHistory", 
                        email: currentUser.email 
                    })
                })
                .then(response => response.json())
                .then(data => {
                    renderHistoryTable(data);
                })
                .catch(err => {
                    console.error(err);
                    tbody.innerHTML = '<tr><td colspan="4" style="text-align:center; color:red;">Failed to load history.</td></tr>';
                });
            } else {
                // 2. MOCK DATA (For Demo)
                setTimeout(() => {
                    const mockData = [
                        { date: "12/01/2025", id: "REQ-001", items: "Folder Legal (5), Ink Black (2)", status: "Completed" },
                        { date: "12/03/2025", id: "REQ-005", items: "Bond Paper A4 (10)", status: "Pending" }
                    ];
                    renderHistoryTable(mockData);
                }, 800);
            }
        }

        function renderHistoryTable(data) {
            const tbody = document.getElementById('user-history-body');
            tbody.innerHTML = '';

            if(data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" style="text-align:center; color:#999;">No transaction history found.</td></tr>';
                return;
            }

            data.forEach(row => {
                let badgeClass = 'status-pending';
                if(row.status === 'Completed' || row.status === 'Approved') badgeClass = 'status-completed';
                if(row.status === 'Rejected') badgeClass = 'status-rejected';

                // CONVERT NEWLINES (\n) TO HTML BREAKS (<br>)
                // We also wrap it in a small span to style it
                const formattedItems = row.items.replace(/\n/g, '<br>');

                tbody.innerHTML += `
                    <tr>
                        <td>${row.date}</td>
                        <td style="font-family:monospace; font-weight:bold; color:var(--primary);">${row.id}</td>
                        <td class="history-items-list" style="line-height: 1.6;">
                            ${formattedItems}
                        </td>
                        <td><span class="status-badge ${badgeClass}">${row.status}</span></td>
                    </tr>
                `;
            });
        }

        function logout() {
            // Clear Session
            localStorage.removeItem('sightSession'); 
            localStorage.removeItem('sightCart'); 
            localStorage.removeItem('sightLastPage'); 
            localStorage.removeItem('sightAdminTab');
            
            // Clear Inventory Cache (So next login fetches fresh)
            localStorage.removeItem('sightInventoryCache'); 

            currentUser = null; 
            cart = [];
            
            document.getElementById('email').value = ''; 
            document.getElementById('password').value = '';
            document.getElementById('cart-count').innerText = '0';
            
            navigate('login-page');
        }

        // Inventory & Search Functions
        function filterCategory(cat, btnElement) {
            currentCategory = cat; searchQuery = ''; document.getElementById('searchInput').value = '';
            if(btnElement) { document.querySelectorAll('.cat-btn').forEach(btn => btn.classList.remove('active')); btnElement.classList.add('active'); }
            renderInventory();
        }

        function handleSearch() {
            searchQuery = document.getElementById('searchInput').value.toLowerCase();
            if (searchQuery.length > 0) {
                currentCategory = 'all';
                document.querySelectorAll('.cat-btn').forEach(btn => {
                    btn.classList.remove('active');
                    if (btn.innerText.trim() === 'All') btn.classList.add('active');
                });
            }
            renderInventory();
        }

        function renderInventory() {
            const container = document.getElementById('inventory-items-container');
            container.innerHTML = '';

            // 1. Filter Logic (Includes the "IT" word boundary fix)
            let filtered = inventoryDB.filter(item => {
                const itemCat = item.category ? item.category.toLowerCase() : "";
                const targetCat = currentCategory.toLowerCase();

                let matchCategory = false;
                if (currentCategory === 'all') {
                    matchCategory = true;
                } else {
                    // Regex \b ensures "IT" matches "IT Accessories" but NOT "Writing"
                    const regex = new RegExp(`\\b${targetCat}`, 'i');
                    matchCategory = regex.test(itemCat);
                }

                const matchSearch = item.name.toLowerCase().includes(searchQuery);
                return matchCategory && matchSearch;
            });

            // 2. SORT LOGIC (Restored): Move Out of Stock items to the bottom
            filtered.sort((a, b) => {
                const stockA = Number(a.stock);
                const stockB = Number(b.stock);
                
                // If A has stock (>0) and B doesn't (<=0), A comes first
                if (stockA > 0 && stockB <= 0) return -1;
                
                // If A has no stock (<=0) and B does (>0), B comes first
                if (stockA <= 0 && stockB > 0) return 1;
                
                // Otherwise keep original order
                return 0;
            });

            // 3. Check Empty Results
            if (filtered.length === 0) {
                container.innerHTML = `<div style="text-align:center; padding:20px; color:#777;">
                    <i class="fa-solid fa-box-open" style="font-size:2rem; margin-bottom:10px;"></i><br>
                    No items found.
                </div>`;
                return;
            }

            // 4. Render HTML
            filtered.forEach(item => {
                const isOutOfStock = Number(item.stock) <= 0;
                
                const div = document.createElement('div');
                div.className = `item-card ${isOutOfStock ? 'no-stock' : ''}`;
                
                div.innerHTML = `
                    ${isOutOfStock ? '<div class="oos-overlay"><span class="oos-text">OUT OF STOCK</span></div>' : ''}
                    <div class="item-info">
                        <div class="item-name">${highlightMatch(item.name, searchQuery)}</div>
                    </div>
                    <div class="item-actions">
                        <input type="number" min="1" id="qty-${item.id}" placeholder="Qty" ${isOutOfStock ? 'disabled' : ''}>
                        <div style="border:1px solid #ccc; padding:5px; border-radius:5px; background:#f9f9f9; width:60px; text-align:center; font-size:12px; display:flex; align-items:center; justify-content:center;">${item.unit}</div>
                        <input type="text" id="note-${item.id}" placeholder="Notes" ${isOutOfStock ? 'disabled' : ''}>
                        <button class="add-btn" onclick="addToCart('${item.id}', this)" ${isOutOfStock ? 'disabled' : ''}>
                            <i class="fa-solid fa-cart-plus"></i>
                        </button>
                    </div>`;
                container.appendChild(div);
            });
        }

        function highlightMatch(text, query) {
            if (!query) return text;
            const regex = new RegExp(`(${query})`, 'gi');
            return text.replace(regex, '<span style="font-weight:bold;">$1</span>');
        }

        // Cart Functions
        function toggleCart() {
            const sidebar = document.getElementById('cart-sidebar');
            const overlay = document.getElementById('cart-overlay');
            sidebar.classList.toggle('open'); overlay.classList.toggle('open');
            if(sidebar.classList.contains('open')) renderCartSidebar();
        }

        function addToCart(id, btnElement) {
            // FIX: Convert both to String for safe comparison
            const item = inventoryDB.find(i => String(i.id) === String(id));
            
            if (!item) {
                console.error("Item not found for ID:", id);
                showToast("Error: Item not found in database.", "error");
                return;
            }

            const qtyInput = document.getElementById(`qty-${id}`);
            const noteInput = document.getElementById(`note-${id}`);
            const qtyToAdd = parseInt(qtyInput.value);

            // 1. Basic Validation
            if(!qtyToAdd || qtyToAdd <= 0) { 
                showToast("Please enter a valid quantity.", "error"); 
                return; 
            }

            // 2. Add/Update Cart
            // FIX: Also convert to String here when searching the cart
            const existingItem = cart.find(c => String(c.id) === String(id));
            
            if(existingItem) { 
                existingItem.qty += qtyToAdd; 
                existingItem.note = noteInput.value; 
            } else { 
                cart.push({ ...item, qty: qtyToAdd, note: noteInput.value }); 
            }

            // 3. Save Logic
            saveCart(); 
            updateCartCount();
            
            // 4. BUTTON ANIMATION
            const originalIcon = btnElement.innerHTML;
            btnElement.classList.add('success');
            btnElement.innerHTML = `<i class="fa-solid fa-check"></i>`;
            
            setTimeout(() => {
                btnElement.classList.remove('success');
                btnElement.innerHTML = originalIcon;
                qtyInput.value = ''; 
                noteInput.value = '';
            }, 1500);

            // 5. Notification
            showToast(`${qtyToAdd} ${item.unit} ${item.name} added!`, "success"); 
        }

        function renderCartSidebar() {
            const container = document.getElementById('cart-sidebar-items');
            const totalSpan = document.getElementById('sidebar-total-count');
            
            container.innerHTML = '';
            
            if(cart.length === 0) {
                container.innerHTML = `
                    <div style="text-align:center; padding:40px; color:#aaa;">
                        <i class="fa-solid fa-basket-shopping" style="font-size:3rem; margin-bottom:20px;"></i>
                        <p>Your cart is empty.</p>
                        <button onclick="toggleCart()" style="margin-top:20px; background:none; border:1px solid #ccc; padding:5px 15px; border-radius:20px; cursor:pointer;">Close</button>
                    </div>`;
                totalSpan.innerText = '0';
                return;
            }

            cart.forEach((item, index) => {
                const div = document.createElement('div');
                div.className = 'sidebar-item';
                div.innerHTML = `
                    <i class="fa-solid fa-trash sidebar-delete" onclick="removeFromCart(${index})" title="Remove"></i>
                    <h4>${item.name}</h4>
                    <div style="font-size:0.85rem; color:#888;">${item.note ? 'Note: ' + item.note : ''}</div>
                    
                    <!-- EDITABLE QUANTITY SECTION -->
                    <div class="sidebar-item-details">
                        <input type="number" class="qty-edit-input" min="1" 
                               value="${item.qty}" 
                               onchange="updateCartItemQty(${index}, this.value)">
                        <span class="unit-text">${item.unit}</span>
                    </div>
                `;
                container.appendChild(div);
            });
            
            totalSpan.innerText = cart.length;
        }

        function removeFromCart(index) { 
            // 1. Remove item from array
            cart.splice(index, 1); 
            
            // 2. Save to storage & update badge
            saveCart(); 
            updateCartCount(); 
            
            // 3. Update the Sidebar UI
            renderCartSidebar(); 

            // 4. THE FIX: Check if we are currently on the Slip Page
            const slipPage = document.getElementById('requisition-page');
            if (slipPage && !slipPage.classList.contains('hidden')) {
                // If yes, re-render the slip table immediately
                prepareSlip(); 
            }
            
            showToast("Item removed.", "info");
        }

        // ================= CHANGE PASSWORD LOGIC (Auto-Logout) =================
        function handleChangePassword() {
            const currentPass = document.getElementById('current-pass').value;
            const newPass = document.getElementById('new-pass').value;
            const confirmPass = document.getElementById('confirm-pass').value;

            // 1. Validation
            if (!currentPass || !newPass || !confirmPass) {
                showToast("Please fill in all password fields.", "error");
                return;
            }
            if (newPass !== confirmPass) {
                showToast("New passwords do not match.", "error");
                return;
            }
            if (newPass.length < 6) {
                showToast("Password must be at least 6 characters.", "error");
                return;
            }

            // 2. Send to Backend
            if (WEB_APP_URL.includes('script.google.com')) {
                showToast("Updating password...", "info");
                
                fetch(WEB_APP_URL, {
                    method: 'POST',
                    body: JSON.stringify({
                        action: "changePassword",
                        email: currentUser.email,
                        oldPass: currentPass,
                        newPass: newPass
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        // SUCCESS: Notify and Logout
                        showToast("Password changed! Logging out...", "success");
                        
                        setTimeout(() => {
                            togglePasswordModal(); // Close modal
                            logout();              // Trigger logout
                        }, 2000); // 2 second delay
                    } else {
                        showToast(data.message, "error");
                    }
                })
                .catch(err => {
                    console.error(err);
                    showToast("Failed to connect to server.", "error");
                });
            } else {
                // Demo Mode Logic
                showToast("Demo: Password changed! Logging out...", "success");
                setTimeout(() => {
                    togglePasswordModal();
                    logout();
                }, 2000);
            }
        }

        // ================= PASSWORD MODAL LOGIC =================
        function togglePasswordModal() {
            const overlay = document.getElementById('pass-overlay');
            const isOpen = overlay.classList.contains('open');
            
            if(isOpen) {
                // Close
                overlay.classList.remove('open');
                // Clear inputs on close
                document.getElementById('current-pass').value = '';
                document.getElementById('new-pass').value = '';
                document.getElementById('confirm-pass').value = '';
            } else {
                // Open
                overlay.classList.add('open');
                document.getElementById('current-pass').focus();
            }
        }

        // ================= UPDATE CART QUANTITY =================
        function updateCartItemQty(index, newVal) {
            let qty = parseInt(newVal);

            // 1. Basic Validation (Must be at least 1)
            if (isNaN(qty) || qty < 1) {
                qty = 1; // Default back to 1 if invalid
                showToast("Minimum quantity is 1", "error");
            }

            // 2. Update Array
            cart[index].qty = qty;

            // 3. Save Changes
            saveCart();
            
            // 4. Update UI (Slip Sync)
            // If the user is currently looking at the Slip, update the table immediately
            const slipPage = document.getElementById('requisition-page');
            if (slipPage && !slipPage.classList.contains('hidden')) {
                prepareSlip();
            }
            
            // Note: We don't re-render sidebar here to prevent input losing focus while typing
        }

        function saveCart() { localStorage.setItem('sightCart', JSON.stringify(cart)); }
        function updateCartCount() { document.getElementById('cart-count').innerText = cart.length; }
        
        function proceedToRequisition() {
            if(cart.length === 0) { showToast("Cart is empty!", "error"); return; }
            toggleCart(); navigate('requisition-page');
        }

        function showToast(message, type = 'success') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div'); toast.className = `toast ${type}`;
            let icon = type === 'error' ? 'fa-circle-exclamation' : 'fa-check-circle';
            toast.innerHTML = `<i class="fa-solid ${icon}"></i> <span>${message}</span>`;
            container.appendChild(toast);
            setTimeout(() => { toast.style.animation = 'fadeOutToast 0.5s ease forwards'; toast.addEventListener('animationend', () => toast.remove()); }, 3000);
        }

        // ================= SLIP LOGIC =================
        function prepareSlip() {
            // 1. Auto Date
            document.getElementById('slip-date').innerText = new Date().toLocaleDateString();
            
            // 2. AUTO-FILL USER DATA (The Fix)
            if(currentUser) {
                document.getElementById('req-name').value = currentUser.name || '';
                document.getElementById('req-section').value = currentUser.dept || '';
                document.getElementById('req-designation').value = currentUser.designation || '';
                document.getElementById('app-name').value = currentUser.approver || '';
            }

            // 3. Render Editable Table
            const container = document.getElementById('slip-items-render-area');
            if(cart.length === 0) {
                container.innerHTML = '<p style="padding:20px; color:#999; text-align:center; font-style:italic;">No items selected.</p>';
                return;
            }

            let html = `
                <table class="slip-table">
                    <thead>
                        <tr>
                            <th style="width:50%">Item Description</th>
                            <th>Unit</th>
                            <th>Qty</th>
                            <th style="text-align:center;">Action</th>
                        </tr>
                    </thead>
                    <tbody>`;
            
            cart.forEach((item, index) => {
                html += `
                    <tr>
                        <td>
                            <span style="font-weight:500;">${item.name}</span>
                            ${item.note ? `<div style="font-size:0.8rem; color:#666;">Note: ${item.note}</div>` : ''}
                        </td>
                        <td>${item.unit}</td>
                        <td>${item.qty}</td>
                        <td style="text-align:center;">
                            <button class="remove-icon" onclick="removeItemFromSlip(${index})" title="Remove Item">
                                <i class="fa-solid fa-trash"></i>
                            </button>
                        </td>
                    </tr>`;
            });
            html += `</tbody></table>`;
            container.innerHTML = html;
        }

        // Toggle Officer Input
        function toggleOfficerFields() {
            const isChecked = document.getElementById('not-present').checked;
            const officerDiv = document.getElementById('officer-fields');
            officerDiv.style.display = isChecked ? 'block' : 'none';
        }

        // Remove Item logic (Syncs everywhere)
        function removeItemFromSlip(index) {
            cart.splice(index, 1); // Remove from array
            saveCart();            // Update LocalStorage
            updateCartCount();     // Update Navbar Badge
            prepareSlip();         // Re-draw Slip Table
            renderCartSidebar();   // Update Sidebar logic (background)
            
            showToast("Item removed.", "info");
        }

        // ================= SLIP CONFIRMATION LOGIC =================
        function validateAndShowConfirm() {
            // 1. Validate Cart
            if(cart.length === 0) { 
                showToast("Cannot submit: Your cart is empty.", "error"); 
                return; 
            }

            // 2. Validate Purpose
            const purpose = document.getElementById('req-purpose').value.trim();
            if(!purpose) {
                showToast("Please fill in the Purpose.", "error");
                document.getElementById('req-purpose').focus();
                return;
            }

            // 3. Validate Officer (if ticked)
            const isNotPresent = document.getElementById('not-present').checked;
            if (isNotPresent) {
                const offName = document.getElementById('off-name').value.trim();
                const offDesig = document.getElementById('off-designation').value.trim();
                if (!offName || !offDesig) {
                    showToast("Please fill in Officer details.", "error");
                    return;
                }
            }

            // If all good, show overlay
            document.getElementById('submit-overlay').classList.add('open');
        }

        function closeSubmitConfirm() {
            document.getElementById('submit-overlay').classList.remove('open');
        }

        function finalizeAndPrint() {
            // 1. Format Items into a Bulleted List String
            // Result: " Item A (1 pc)\n Item B (2 pcs)"
            const itemsListString = cart.map(i => ` ${i.name} (${i.qty} ${i.unit})`).join('\n');

            // 2. Prepare Data
            const transactionData = {
                action: "submitTransaction",
                email: currentUser.email,
                name: currentUser.name,
                items: itemsListString, // Sending the bulleted list
                purpose: document.getElementById('req-purpose').value,
                date: new Date().toLocaleDateString()
            };

            // 3. UI Feedback
            const printBtn = document.querySelector('.btn-print');
            printBtn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Saving...';
            printBtn.disabled = true;

            // 4. Send to Backend
            if (WEB_APP_URL.includes('script.google.com')) {
                fetch(WEB_APP_URL, {
                    method: 'POST',
                    body: JSON.stringify(transactionData)
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        executePrintSequence();
                    } else {
                        showToast("Error saving: " + data.message, "error");
                        printBtn.disabled = false;
                        printBtn.innerHTML = '<i class="fa-solid fa-print"></i> Print';
                    }
                })
                .catch(err => {
                    console.error(err);
                    executePrintSequence(); // Fallback
                });
            } else {
                setTimeout(() => { executePrintSequence(); }, 1000);
            }
        }

        function executePrintSequence() {
            // A. Prepare the hidden print template (Same logic as before)
            fillPrintTemplate(); 

            // B. Close Overlay
            closeSubmitConfirm();
            document.querySelector('.btn-print').innerHTML = '<i class="fa-solid fa-print"></i> Print';
            document.querySelector('.btn-print').disabled = false;

            // C. Trigger Print
            window.print();

            // D. Clear Cart & Reset
            cart = [];
            saveCart();
            updateCartCount();
            document.getElementById('req-purpose').value = '';
            document.getElementById('slip-items-render-area').innerHTML = '<p style="text-align:center; color:#999;">Request Submitted.</p>';
            renderCartSidebar();
            
            showToast("Transaction saved successfully!", "success");
        }

        // Helper to fill the template (Extracted from old submitAndPrint)
        function fillPrintTemplate() {
            // Fill Header
            document.getElementById('print-section').innerText = document.getElementById('req-section').value;
            
            // Fill Items
            const printBody = document.getElementById('print-items-body');
            printBody.innerHTML = '';
            cart.forEach((item, index) => {
                printBody.innerHTML += `
                    <tr>
                        <td>${index + 1}</td>
                        <td>${item.unit}</td>
                        <td style="text-align:left; padding-left:10px;">${item.name}</td>
                        <td>${item.qty}</td>
                        <td></td> <td></td> <td></td> <td></td>
                    </tr>`;
            });
            printBody.innerHTML += `<tr><td colspan="8" style="text-align:center; font-style:italic; font-weight:bold; padding: 10px;">X X X X X X X X X X &nbsp; NOTHING FOLLOWS &nbsp; X X X X X X X X X X</td></tr>`;

            // Fill Details
            document.getElementById('print-purpose').innerText = document.getElementById('req-purpose').value;
            document.getElementById('print-req-name').innerText = document.getElementById('req-name').value;
            document.getElementById('print-req-designation').innerText = document.getElementById('req-designation').value;
            document.getElementById('print-req-date').innerText = new Date().toLocaleDateString();

            if(document.getElementById('not-present').checked) {
                document.getElementById('print-app-name').innerText = document.getElementById('off-name').value;
                document.getElementById('print-app-designation').innerText = document.getElementById('off-designation').value;
            } else {
                document.getElementById('print-app-name').innerText = document.getElementById('app-name').value;
                document.getElementById('print-app-designation').innerText = "Head of Office";
            }
        }

        // ================= ADMIN FUNCTIONS =================
        function initAdminDashboard() {
            renderPendingRequests(); 
            renderLogs(); 
            renderStockStatus();
            
            // LOAD REAL ANALYTICS
            fetchAnalyticsData(); 
            // Note: fetchAnalyticsData() calls updateDashboard() once data arrives

            // Tab logic...
            const lastTab = localStorage.getItem('sightAdminTab') || 'tab-charts';
            const targetBtn = document.querySelector(`.tab-btn[onclick*="${lastTab}"]`);
            if(targetBtn) switchAdminTab(lastTab, targetBtn);
        }

        function switchAdminTab(tabId, btnElement) {
            document.querySelectorAll('.admin-content-panel').forEach(el => el.classList.remove('active'));
            document.getElementById(tabId).classList.add('active');
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            btnElement.classList.add('active');
            if(tabId === 'tab-charts') renderChart();
            localStorage.setItem('sightAdminTab', tabId);
        }

        function renderStockStatus() {
            const lowContainer = document.getElementById('stock-low-list');
            const midContainer = document.getElementById('stock-mid-list');
            const highContainer = document.getElementById('stock-high-list');
            lowContainer.innerHTML = ''; midContainer.innerHTML = ''; highContainer.innerHTML = '';

            inventoryDB.forEach(item => {
                const html = `<div class="stock-item-row"><span>${item.name}</span><span style="font-weight:bold;">${item.stock}</span></div>`;
                if (item.stock < 15) lowContainer.innerHTML += html;
                else if (item.stock <= 40) midContainer.innerHTML += html;
                else highContainer.innerHTML += html;
            });
        }

        function renderPendingRequests() {
            const tbody = document.getElementById('pending-table-body');
            tbody.innerHTML = '';

            // FILTER: Only show "Pending"
            const pendingList = rawTransactionsCache.filter(t => t.status === 'Pending');

            if (pendingList.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align:center; padding:20px; color:#999;">No pending requests.</td></tr>';
                return;
            }

            pendingList.forEach(req => {
                // We pass the entire 'req' object to the modal so we can edit it
                // We use single quotes for the onclick string to avoid conflicts
                const reqString = JSON.stringify(req).replace(/'/g, "&#39;");

                tbody.innerHTML += `
                    <tr>
                        <td>${req.date}</td>
                        <td>${req.email}</td>
                        <td>${req.unit}</td>
                        <td><span class="status-badge status-pending">Pending</span></td>
                        <td>
                            <button class="view-btn" onclick='openAdminModal(${reqString})'>
                                View / Action
                            </button>
                        </td>
                    </tr>`;
            });
        }

        let currentAdminViewReq = null; // Store current request being viewed

        function openAdminModal(reqData) {
            currentAdminViewReq = reqData; // Save for printing/updating
            
            document.getElementById('view-id').innerText = "ID-Loading..."; // We need ID from backend
            document.getElementById('view-date').innerText = reqData.date;
            document.getElementById('view-name').innerText = reqData.email; // Or Name if available
            document.getElementById('view-unit').innerText = reqData.unit;
            document.getElementById('view-purpose').innerText = "Request"; // Need purpose from backend

            // Parse Items for Editable Table
            const tbody = document.getElementById('view-items-body');
            tbody.innerHTML = '';
            
            const lines = reqData.itemsString.split('\n');
            lines.forEach((line, index) => {
                const clean = line.replace(' ', '');
                const match = clean.match(/^(.*?) \((\d+) (.*?)\)/); 
                
                if(match) {
                    const name = match[1];
                    const qty = match[2];
                    const unit = match[3];
                    
                    tbody.innerHTML += `
                        <tr class="admin-item-row" data-name="${name}" data-unit="${unit}">
                            <td>${name}</td>
                            <td><input type="number" value="${qty}" style="width:60px; padding:5px;"></td>
                            <td><button onclick="this.closest('tr').remove()" style="color:red; border:none; background:none; cursor:pointer;"><i class="fa-solid fa-trash"></i></button></td>
                        </tr>
                    `;
                }
            });

            document.getElementById('admin-view-overlay').classList.add('open');
        }

        function closeAdminModal() {
            document.getElementById('admin-view-overlay').classList.remove('open');
        }

        // PRINT FUNCTION (Reuses your template!)
        function printAdminSlip() {
            if(!currentAdminViewReq) return;

            // 1. Gather Data from Admin Modal (in case of edits)
            const rows = document.querySelectorAll('.admin-item-row');
            const items = [];
            rows.forEach(row => {
                items.push({
                    name: row.getAttribute('data-name'),
                    unit: row.getAttribute('data-unit'),
                    qty: row.querySelector('input').value
                });
            });

            // 2. Fill Template
            document.getElementById('print-section').innerText = currentAdminViewReq.unit;
            document.getElementById('print-purpose').innerText = "Admin Reprint"; 
            document.getElementById('print-req-name').innerText = currentAdminViewReq.email; 
            document.getElementById('print-req-date').innerText = currentAdminViewReq.date;
            
            // Fill Items
            const printBody = document.getElementById('print-items-body');
            printBody.innerHTML = '';
            items.forEach((item, index) => {
                printBody.innerHTML += `
                    <tr>
                        <td>${index + 1}</td>
                        <td>${item.unit}</td>
                        <td style="text-align:left; padding-left:10px;">${item.name}</td>
                        <td>${item.qty}</td>
                        <td></td><td></td><td></td><td></td>
                    </tr>`;
            });
            printBody.innerHTML += `<tr><td colspan="8" style="text-align:center; font-style:italic; font-weight:bold;">X X X NOTHING FOLLOWS X X X</td></tr>`;

            // 3. Print
            window.print();
        }

        // APPROVE / REJECT
        function updateRequestStatus(newStatus) {
            // 1. Rebuild Items String (incase admin changed qty or deleted items)
            const rows = document.querySelectorAll('.admin-item-row');
            let newItemsString = "";
            rows.forEach(row => {
                const name = row.getAttribute('data-name');
                const unit = row.getAttribute('data-unit');
                const qty = row.querySelector('input').value;
                newItemsString += ` ${name} (${qty} ${unit})\n`;
            });

            // 2. Send to Backend
            // Note: We need the REQ ID. In 'getAllTransactions', ensure you return 'id'.
            // Assuming currentAdminViewReq has an .id property (Update Apps Script if not)
            
            /* 
               CRITICAL: Update your Apps Script 'getAllTransactions' to return:
               { id: transRows[i][0], purpose: transRows[i][4], status: transRows[i][5], ... }
            */

            fetch(WEB_APP_URL, {
                method: 'POST',
                body: JSON.stringify({
                    action: "updateTransaction",
                    reqId: currentAdminViewReq.id, // Ensure this exists!
                    status: newStatus,
                    items: newItemsString
                })
            })
            .then(res => res.json())
            .then(data => {
                if(data.status === 'success') {
                    showToast(`Request ${newStatus}!`, "success");
                    closeAdminModal();
                    fetchAnalyticsData(); // Refresh table
                } else {
                    showToast("Error updating.", "error");
                }
            });
        }

        function renderLogs() {
            const tbody = document.getElementById('logs-table-body');
            tbody.innerHTML = '';

            // FILTER: Show everything EXCEPT Pending
            const logList = rawTransactionsCache.filter(t => t.status !== 'Pending');

            // Sort by Date (Newest First) if possible, or assume Sheet is ordered
            // Let's reverse it to show newest on top
            const sortedLogs = logList.reverse();

            if (sortedLogs.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" style="text-align:center; padding:20px; color:#999;">No activity history yet.</td></tr>';
                return;
            }

            sortedLogs.forEach(log => {
                let badgeClass = 'status-pending';
                if(log.status === 'Completed' || log.status === 'Approved') badgeClass = 'status-completed';
                if(log.status === 'Rejected') badgeClass = 'status-rejected';

                // Format items for display (Newlines to <br>)
                const formattedItems = log.itemsString ? log.itemsString.replace(/\n/g, '<br>') : "No items";

                tbody.innerHTML += `
                    <tr>
                        <td style="white-space:nowrap;">${log.date}</td>
                        <td>
                            <strong>${log.email}</strong><br>
                            <small style="color:#777;">${log.unit}</small>
                        </td>
                        <td style="font-size:0.85rem; line-height:1.4;">${formattedItems}</td>
                        <td><span class="status-badge ${badgeClass}">${log.status}</span></td>
                    </tr>`;
            });
        }

        let myChart = null;
        function renderChart() {
            const ctx = document.getElementById('trendsChart').getContext('2d');
            if(myChart) myChart.destroy();
            myChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['Folders', 'Paper', 'Inks', 'Pens', 'IT Acc', 'Tape'],
                    datasets: [{
                        label: 'Requests this Month',
                        data: [12, 19, 3, 5, 2, 8],
                        backgroundColor: '#D4AF37',
                        borderRadius: 5
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true } } }
            });
        }

        function submitAndPrint() {
            // 1. Validate Cart
            if(cart.length === 0) { 
                showToast("Cannot print: Your cart is empty.", "error"); 
                return; 
            }

            // 2. Validate Purpose
            const purpose = document.getElementById('req-purpose').value.trim();
            if(!purpose) {
                showToast("Please fill in the Purpose of the request.", "error");
                document.getElementById('req-purpose').focus();
                return;
            }

            // 3. NEW VALIDATION: Officer of the Day
            const isNotPresent = document.getElementById('not-present').checked;
            
            if (isNotPresent) {
                const offName = document.getElementById('off-name').value.trim();
                const offDesig = document.getElementById('off-designation').value.trim();

                if (!offName) {
                    showToast("Please enter the Officer of the Day's Name.", "error");
                    document.getElementById('off-name').focus();
                    return;
                }
                if (!offDesig) {
                    showToast("Please enter the Officer's Designation.", "error");
                    document.getElementById('off-designation').focus();
                    return;
                }
            }

            // 4. FILL DATA (Prepare Template)
            document.getElementById('print-section').innerText = document.getElementById('req-section').value;
            
            const printBody = document.getElementById('print-items-body');
            printBody.innerHTML = '';
            
            // Loop Items
            cart.forEach((item, index) => {
                printBody.innerHTML += `
                    <tr>
                        <td>${index + 1}</td>
                        <td>${item.unit}</td>
                        <td style="text-align:left; padding-left:10px;">${item.name}</td>
                        <td>${item.qty}</td>
                        <td></td> <td></td> <td></td> <td></td>
                    </tr>`;
            });

            // "Nothing Follows" Row
            printBody.innerHTML += `
                <tr>
                    <td colspan="8" style="text-align:center; font-style:italic; font-weight:bold; padding: 10px;">
                        X X X X X X X X X X X X X X &nbsp; NOTHING FOLLOWS &nbsp; X X X X X X X X X X X X X X
                    </td>
                </tr>`;

            // Purpose
            document.getElementById('print-purpose').innerText = purpose;

            // Signatories
            document.getElementById('print-req-name').innerText = document.getElementById('req-name').value;
            document.getElementById('print-req-designation').innerText = document.getElementById('req-designation').value;
            document.getElementById('print-req-date').innerText = new Date().toLocaleDateString();

            // Approver Logic (Mapped for Print)
            if(isNotPresent) {
                document.getElementById('print-app-name').innerText = document.getElementById('off-name').value;
                document.getElementById('print-app-designation').innerText = document.getElementById('off-designation').value;
            } else {
                document.getElementById('print-app-name').innerText = document.getElementById('app-name').value;
                document.getElementById('print-app-designation').innerText = "Head of Office"; 
            }

            // 5. Print
            window.print();
        }

        // ================= GRAPHICAL DASHBOARD LOGIC (Real Data) =================
        
        // This will hold the parsed data from Google Sheets
        let realTransactions = []; 
        let charts = {}; 

        // Global variable to store all transactions
        let rawTransactionsCache = []; 

        function fetchAnalyticsData() {
            if(!WEB_APP_URL.includes('script.google.com')) return;

            fetch(WEB_APP_URL, {
                method: 'POST',
                body: JSON.stringify({ action: "getAllTransactions" })
            })
            .then(response => response.json())
            .then(rawList => {
                // 1. Save Data
                rawTransactionsCache = rawList; 
                
                // 2. RENDER TABLES (The Move Logic)
                renderPendingRequests(); // Shows only Pending
                renderLogs();            // Shows Approved/Rejected

                // 3. Parse for Charts (Existing Logic)
                realTransactions = []; 
                rawList.forEach(trans => {
                    const lines = trans.itemsString.split('\n');
                    lines.forEach(line => {
                        const cleanLine = line.replace(' ', '').trim();
                        const match = cleanLine.match(/^(.*?) \((\d+)/); 
                        if (match) {
                            const itemName = match[1];
                            const qty = parseInt(match[2]);
                            const invItem = inventoryDB.find(i => i.name === itemName);
                            realTransactions.push({
                                date: trans.date, unit: trans.unit, item: itemName,
                                category: invItem ? invItem.category : "IT", qty: qty
                            });
                        }
                    });
                });
                updateDashboard();
            })
            .catch(err => console.error("Analytics Error:", err));
        }

        // 2. MAIN UPDATE FUNCTION
        function updateDashboard() {
            const dateFilter = document.getElementById('dash-date-filter').value;
            const unitFilter = document.getElementById('dash-unit-filter').value;

            // Helper: Check Date
            const checkDate = (t) => {
                if (dateFilter === 'all') return true;
                return t.date.startsWith(dateFilter); // Checks if '2025-05-01' starts with '2025'
            };

            // A. Fully Filtered (Date + Unit) -> For Charts & Volumes
            const fullyFiltered = realTransactions.filter(t => {
                const dateMatch = checkDate(t);
                const unitMatch = unitFilter === 'all' || t.unit === unitFilter;
                return dateMatch && unitMatch;
            });

            // B. Date Only Filtered -> For Top Requestors (Comparing Units)
            const dateOnlyFiltered = realTransactions.filter(t => {
                return checkDate(t);
            });

            // Update UI
            updateSummaries(fullyFiltered, dateOnlyFiltered);
            renderVolumeChart(fullyFiltered);
            renderCategoryChart(fullyFiltered);
            updateBarChart(fullyFiltered); 
            updateItemDatalist(fullyFiltered);
        }

        // 3. SUMMARIES
        function updateSummaries(data, dataForUnits) {
            // Total Requests (Count unique transactions? Or total items? Let's do total Items dispensed)
            // Or if you want total "Requests" (Slips), we'd need to count unique Dates+Units.
            // For now, let's show Total Items Requested as it's easier with this data structure.
            const totalQty = data.reduce((sum, t) => sum + t.qty, 0);
            document.getElementById('sum-total-req').innerText = totalQty;

            // Top Items
            const itemCounts = {};
            data.forEach(d => { itemCounts[d.item] = (itemCounts[d.item] || 0) + d.qty; });
            const sortedItems = Object.entries(itemCounts).sort((a,b) => b[1] - a[1]).slice(0, 3);
            
            document.getElementById('sum-top-items').innerHTML = sortedItems.map((i, idx) => 
                `<li><span>${idx+1}. ${i[0]}</span> <span>${i[1]}</span></li>`
            ).join('');

            // Top Units (Based on total items requested)
            const unitCounts = {};
            dataForUnits.forEach(d => { unitCounts[d.unit] = (unitCounts[d.unit] || 0) + d.qty; }); 
            const sortedUnits = Object.entries(unitCounts).sort((a,b) => b[1] - a[1]).slice(0, 3);

            document.getElementById('sum-top-units').innerHTML = sortedUnits.map((u, idx) => 
                `<li><span><i class="fa-solid fa-medal"></i> ${u[0]}</span> <span>${u[1]} items</span></li>`
            ).join('');
        }

        // 4. CHARTS
        function renderVolumeChart(data) {
            const ctx = document.getElementById('chartVolume').getContext('2d');
            
            // Group by Month (YYYY-MM)
            const months = {};
            data.forEach(d => {
                const m = d.date.substring(0, 7); 
                months[m] = (months[m] || 0) + d.qty;
            });
            const sortedMonths = Object.keys(months).sort();

            const chartData = {
                labels: sortedMonths,
                datasets: [{
                    label: 'Items Requested',
                    data: sortedMonths.map(m => months[m]),
                    borderColor: '#D4AF37',
                    backgroundColor: 'rgba(212, 175, 55, 0.1)',
                    fill: true,
                    tension: 0.4
                }]
            };

            if (charts.volume) charts.volume.destroy();
            charts.volume = new Chart(ctx, { type: 'line', data: chartData, options: { responsive: true, maintainAspectRatio: false } });
        }

        function renderCategoryChart(data) {
            const ctx = document.getElementById('chartCategory').getContext('2d');
            const cats = {};
            data.forEach(d => { cats[d.category] = (cats[d.category] || 0) + d.qty; });

            const chartData = {
                labels: Object.keys(cats),
                datasets: [{
                    data: Object.values(cats),
                    backgroundColor: ['#e74c3c', '#3498db', '#f1c40f', '#2ecc71', '#9b59b6', '#34495e']
                }]
            };

            if (charts.category) charts.category.destroy();
            charts.category = new Chart(ctx, { type: 'doughnut', data: chartData, options: { responsive: true, maintainAspectRatio: false } });
        }

        function updateBarChart(globalFilteredData) {
            const data = globalFilteredData || realTransactions; 
            const catFilter = document.getElementById('dash-cat-filter').value;

            // Handle filter logic again here for the local dropdown
            const finalData = data.filter(d => catFilter === 'all' || d.category.includes(catFilter));

            const itemCounts = {};
            finalData.forEach(d => { itemCounts[d.item] = (itemCounts[d.item] || 0) + d.qty; });
            const sorted = Object.entries(itemCounts).sort((a,b) => b[1] - a[1]).slice(0, 10);

            const ctx = document.getElementById('chartItemsBar').getContext('2d');
            const chartData = {
                labels: sorted.map(s => s[0]),
                datasets: [{
                    label: 'Qty Requested',
                    data: sorted.map(s => s[1]),
                    backgroundColor: '#3498db',
                    indexAxis: 'y'
                }]
            };

            if (charts.bar) charts.bar.destroy();
            charts.bar = new Chart(ctx, { type: 'bar', data: chartData, options: { indexAxis: 'y', responsive: true, maintainAspectRatio: false } });
        }

        // 5. PREDICTIVE SEARCH TREND
        function updateItemDatalist(data) {
            const datalist = document.getElementById('items-datalist');
            const uniqueItems = [...new Set(data.map(d => d.item))];
            datalist.innerHTML = uniqueItems.map(i => `<option value="${i}">`).join('');
        }

        function predictItemSearch() {
            const query = document.getElementById('dash-item-search').value;
            const ctx = document.getElementById('chartItemTrend').getContext('2d');
            
            // Filter global data by item name match
            const matchingData = realTransactions.filter(d => d.item.toLowerCase().includes(query.toLowerCase()));
            
            const months = {};
            matchingData.forEach(d => {
                const m = d.date.substring(0, 7);
                months[m] = (months[m] || 0) + d.qty;
            });
            const sortedMonths = Object.keys(months).sort();

            const chartData = {
                labels: sortedMonths,
                datasets: [{
                    label: query ? `Trend for "${query}"` : 'Trend (All Items)',
                    data: sortedMonths.map(m => months[m]),
                    borderColor: '#2ecc71',
                    tension: 0.1
                }]
            };

            if (charts.trend) charts.trend.destroy();
            charts.trend = new Chart(ctx, { type: 'line', data: chartData, options: { responsive: true, maintainAspectRatio: false } });
        }

    </script>
</body>
</html>